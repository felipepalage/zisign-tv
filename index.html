<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ZiSign TV</title>
<link rel="icon" type="image/png" href="img/ZiSignPNG.png"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet"/>

<style>
  :root{
    --bg:#050609;
    --grad-a:#071e18;
    --grad-b:#061527;
    --panel:#0c1116;
    --panel-soft:#121922;
    --border-soft:rgba(255,255,255,.06);
    --text:#f4f8f7;
    --muted:#9fb4c0;
    --accent:#00f0c0;
    --accent-soft:#00d187;
    --danger:#ff5c7a;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 90% -10%, var(--grad-a) 0%, transparent 60%),
      radial-gradient(900px 700px at 10% 110%, var(--grad-b) 0%, transparent 60%),
      linear-gradient(180deg,#050609 0%,#05070a 45%,#050508 100%);
    overflow:hidden;
    font-size:14px;
  }

  .wrap{
    position:relative;
    height:100vh;
    padding:16px 18px;
    display:grid;
    grid-template-rows:auto 1fr auto;
    row-gap:14px;
    max-width:1920px;
    margin:0 auto;
    overflow:hidden;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    background:linear-gradient(135deg,rgba(12,17,22,.95),rgba(12,17,22,.94));
    border-radius:16px;
    padding:10px 18px;
    border:1px solid var(--border-soft);
    box-shadow:0 18px 50px rgba(0,0,0,.6),0 0 0 1px rgba(0,0,0,.5);
  }
  .brand{display:flex;align-items:center;gap:14px;}
  .brand img{height:82px;width:auto;}
  .brand-info{display:flex;flex-direction:column;gap:2px;}
  .brand-title{font-weight:800;font-size:16px;letter-spacing:.05em;text-transform:uppercase;}
  .brand-sub{font-size:12px;color:var(--muted);opacity:.9;}

  .clock{
    font-weight:800;letter-spacing:.14em;font-size:13px;color:var(--accent);
    padding:7px 14px;border-radius:999px;border:1px solid rgba(0,255,194,.35);
    background:radial-gradient(circle at 0 50%,rgba(0,255,194,.12),transparent 65%);
    white-space:nowrap;
  }

  .top-grid{
    display:grid;
    grid-template-columns:1.1fr 1fr 1.4fr;
    gap:14px;
    min-height:0;
  }

  .card{
    background:
      radial-gradient(circle at 0 0,rgba(0,255,194,.08),transparent 55%),
      radial-gradient(circle at 100% 100%,rgba(0,128,255,.06),transparent 55%),
      linear-gradient(180deg,var(--panel) 0%,#080c11 100%);
    border-radius:16px;
    border:1px solid var(--border-soft);
    box-shadow:0 18px 60px rgba(0,0,0,.7);
    padding:12px 18px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
  }

  .card-header{
    display:flex;align-items:center;justify-content:space-between;gap:8px;
    font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);opacity:.95;
  }
  .label-pill{
    padding:4px 9px;border-radius:999px;border:1px solid rgba(0,255,194,.22);
    color:var(--accent);font-weight:700;white-space:nowrap;
  }

  .total-wrap{display:flex;align-items:center;justify-content:space-between;gap:12px;}
  .total-main{display:flex;flex-direction:column;gap:4px;}
  .total-value{font-size:34px;line-height:1;font-weight:900;}
  .total-sub{font-size:13px;color:var(--muted);}
  .total-pill{display:flex;flex-direction:column;align-items:flex-end;gap:6px;}
  .total-label-small{font-size:12px;color:var(--muted);}
  .total-badge{
    font-size:12px;font-weight:900;color:#061017;
    background:linear-gradient(135deg,var(--accent),var(--accent-soft));
    padding:6px 10px;border-radius:999px;box-shadow:0 10px 28px rgba(0,255,194,.45);
  }

  .pending-title{
    font-size:11px;text-transform:uppercase;letter-spacing:.16em;color:var(--muted);opacity:.9;
  }
  .delay-list{min-height:0;overflow:hidden}
  .delay-track{display:flex;flex-direction:column;gap:6px}
  .delay-item{display:flex;flex-direction:column;gap:4px;font-size:11px}
  .delay-header{display:flex;align-items:center;justify-content:space-between}
  .delay-op{color:var(--text);font-weight:800;opacity:.95}
  .delay-rank{font-size:10px;color:var(--muted);opacity:.85}
  .delay-meter{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .delay-bar-outer{height:6px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;position:relative}
  .delay-bar-inner{position:absolute;inset:0;border-radius:inherit;background:linear-gradient(90deg,var(--danger),#ff8b8b)}
  .delay-time{font-variant-numeric:tabular-nums;color:var(--muted);font-size:11px}
  .delay-status{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:var(--danger);opacity:.9}

  .gauge-main{flex:1;display:grid;place-items:center}
  .ring{width:100%;max-width:230px;aspect-ratio:1/1;position:relative}
  .ring svg{width:100%;height:100%;transform:rotate(-90deg)}
  .ring .value{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
  .ring .value-num{font-size:32px;font-weight:900}

  .topfund-main{flex:1;display:flex;flex-direction:column;gap:8px;min-height:0}
  .topfund-headline{font-size:13px;font-weight:900}
  .topfund-chart-wrap{
    flex:1;min-height:200px;border-radius:12px;padding:6px 8px;
    background:radial-gradient(circle at 0 100%,rgba(0,255,194,.08),transparent 65%);
    border:1px solid rgba(255,255,255,.06);
  }
  .topfund-chart-wrap canvas{width:100% !important;height:100% !important}
  .topfund-list{display:flex;flex-direction:column;gap:3px;font-size:12px}
  .topfund-item{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:6px}
  .tf-pos{font-weight:900;color:var(--accent);min-width:26px}
  .tf-name{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .tf-delay{color:var(--muted);font-weight:800}

  /* ======= FIX PRINCIPAL (ficou “estranho”): tabela responsiva + colunas coerentes ======= */
  .ticker{
    background:linear-gradient(180deg,var(--panel-soft) 0%,#080b10 100%);
    border-radius:16px;border:1px solid var(--border-soft);
    box-shadow:0 16px 55px rgba(0,0,0,.7);
    display:flex;flex-direction:column;min-height:0;
  }
  .ticker-head{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06);
    font-size:12px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;
  }

  .table{
    display:flex;flex-direction:column;gap:8px;
    padding:12px 14px;
    overflow:auto;
    min-height:0;
  }

  .row{
    display:grid;
    grid-template-columns: 92px minmax(280px, 1fr) 120px 120px;
    gap:10px;
    align-items:center;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(14,26,34,.75);
    border:1px solid rgba(255,255,255,.06);
  }

  .pill{
    padding:4px 10px;border-radius:999px;
    background:rgba(0,255,194,.12);
    border:1px solid rgba(0,255,194,.55);
    font-size:12px;color:var(--accent);font-weight:900;
    width:max-content;
  }

  .badge{
    padding:4px 10px;border-radius:999px;
    font-weight:900;font-size:11px;
    width:max-content;
  }
  .badge.danger{background:rgba(255,92,122,.15);border:1px solid rgba(255,92,122,.35);color:var(--danger)}
  .badge.ok{background:rgba(0,255,194,.10);border:1px solid rgba(0,255,194,.30);color:var(--accent)}

  .small{
    color:var(--muted);
    font-size:11px;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    max-width:100%;
  }

  /* Scroll bonito */
  .table::-webkit-scrollbar{height:10px;width:10px}
  .table::-webkit-scrollbar-thumb{background:rgba(255,255,255,.10);border-radius:999px}
  .table::-webkit-scrollbar-track{background:rgba(255,255,255,.04);border-radius:999px}

  footer{
    display:flex;align-items:center;justify-content:space-between;gap:16px;
    font-size:11px;color:var(--muted);opacity:.9;
    padding:10px 14px;background:linear-gradient(180deg,var(--panel-soft) 0%,#080b10 100%);
    border:1px solid var(--border-soft);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.7);
  }

  @media (max-width:1400px){
    .wrap{padding:12px 12px}
    header{flex-direction:column;align-items:flex-start}
    .top-grid{grid-template-columns:1fr}

    /* FIX: linha vira 2 linhas (não “quebra estranho”) */
    .row{
      grid-template-columns: 92px 1fr;
      grid-template-areas:
        "hora  info"
        "status atraso";
      row-gap:6px;
      align-items:start;
    }
    .row > :nth-child(1){grid-area:hora}
    .row > :nth-child(2){grid-area:info}
    .row > :nth-child(3){grid-area:status}
    .row > :nth-child(4){grid-area:atraso; justify-self:end}

    footer{flex-direction:column;align-items:flex-start}
  }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="img/ZiSignPNG.png" alt="ZiSign"/>
      <div class="brand-info">
        <div class="brand-title">ZiSign TV</div>
        <div class="brand-sub" id="envText">Local</div>
      </div>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </header>

  <section class="top-grid">
    <article class="card">
      <div class="card-header">
        <span>Visão geral</span>
        <span class="label-pill">Total de assinaturas exibidas</span>
      </div>

      <div class="total-wrap">
        <div class="total-main">
          <div class="total-value" id="totalCount">0</div>
          <div class="total-sub" id="subCount">—</div>
        </div>
        <div class="total-pill">
          <div class="total-label-small">Status do painel</div>
          <div class="total-badge" id="panelStatus">Atualizado</div>
        </div>
      </div>

      <div class="pending-ops">
        <div class="pending-title">Top operações com maior atraso</div>
        <div class="delay-list" style="max-height:120px;">
          <div class="delay-track" id="delayListTop"></div>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <span>Ritmo de assinaturas</span>
        <span class="label-pill" id="rateTextMain">—</span>
      </div>
      <div class="gauge-main">
        <div class="ring">
          <svg viewBox="0 0 120 120" preserveAspectRatio="xMidYMid meet">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#00ffc2"/>
                <stop offset="100%" stop-color="#00b8ff"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="10" />
            <circle id="arc" cx="60" cy="60" r="50" fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" stroke-dasharray="0 999" />
          </svg>
          <div class="value"><div class="value-num" id="rateNum">0</div></div>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <span>Fundos que mais atrasam</span>
        <span class="label-pill">Atraso médio (últimos 7 dias)</span>
      </div>
      <div class="topfund-main">
        <div class="topfund-headline" id="topFundHeadline">Nenhum atraso registrado</div>
        <div class="topfund-chart-wrap"><canvas id="chartTopFundos"></canvas></div>
        <div class="topfund-list" id="topFundList"></div>
      </div>
    </article>
  </section>

  <section class="ticker" aria-live="polite">
    <div class="ticker-head">
      <span>Assinaturas pendentes (ordenadas por atraso)</span>
      <span id="rateTextSecondary" style="opacity:.9;font-size:inherit;"></span>
    </div>
    <div class="table" id="tickerTable"></div>
  </section>

  <footer>
    <div id="footerRateText"></div>
    <div id="footerRateSecondary"></div>
    <div style="white-space:nowrap;opacity:.75">contato@zisign.ai — © 2025 ZiSign</div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const CFG = {
  cnpj:  "54638076000176",
  base:  "https://localhost:7003",
  amb:   "custodia",
  token: "DHQzckJ0TGWHiFxaVuUlmrBLWXwuejrtSAT0Mf47gvclZ5GKY543iYKNeLfqlzngXH0YcKGLe4qyv0avru3xeVGBp9yUQKKKlSyJ" 
};

(() => {
  const q = new URLSearchParams(location.search);
  for (const k of ["base","cnpj","amb","token"]) if (q.get(k)) CFG[k] = q.get(k);
  document.getElementById("envText").textContent = `${CFG.base} · ${CFG.amb}`;
})();

const API_URL = `${CFG.base}/api/ZiSign/TV?cnpjCertificadora=${encodeURIComponent(CFG.cnpj)}`;

const elClock   = document.getElementById("clock");
const elTotal   = document.getElementById("totalCount");
const elSub     = document.getElementById("subCount");
const elTable   = document.getElementById("tickerTable");
const elRateTextMain = document.getElementById("rateTextMain");
const elRateTextSecondary = document.getElementById("rateTextSecondary");
const elRateNum = document.getElementById("rateNum");
const elPanelStatus = document.getElementById("panelStatus");
const arc       = document.getElementById("arc");
const elDelayListTop = document.getElementById("delayListTop");
const elTopFundHeadline = document.getElementById("topFundHeadline");
const elTopFundList = document.getElementById("topFundList");
const elFooterRateText = document.getElementById("footerRateText");
const elFooterRateSecondary = document.getElementById("footerRateSecondary");

const STORAGE_KEY = "zisign_tv_hist_7d";
const MILLIS_7D = 7 * 24 * 60 * 60 * 1000;

const pad2 = n => (n<10 ? "0"+n : ""+n);
const formatCnpj = cnpj => {
  const d = (cnpj || "").toString().replace(/\D/g,"");
  if (d.length !== 14) return cnpj || "";
  return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,"$1.$2.$3/$4-$5");
};
const formatDurationFromSeconds = totalSeconds => {
  const s = Math.max(0, Math.floor(totalSeconds || 0));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${pad2(h)}:${pad2(m)}}:${pad2(sec)}`.replace("}:",":"); // safe
};
const abreviarFundo = (nome, max=24) => {
  if(!nome) return "";
  const n = nome.trim();
  if(n.length <= max) return n;
  return n.slice(0, max-1) + "…";
};

function animateCount(el, from, to, duration=350){
  const start = performance.now();
  function step(ts){
    const p = Math.min(1, (ts-start)/duration);
    const val = Math.round(from + (to-from)*p);
    el.textContent = val.toLocaleString("pt-BR");
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

setInterval(()=>{
  const d = new Date();
  elClock.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}, 1000);

function updateGauge(val){
  const max = 60;
  const pct = Math.max(0, Math.min(1, val/max));
  const C = 2 * Math.PI * 50;
  const dash = (C * pct).toFixed(1);
  arc.setAttribute("stroke-dasharray", `${dash} ${Math.max(0,C-dash).toFixed(1)}`);
  elRateNum.textContent = val.toFixed(0);
  const txt = `${val} evento${val !== 1 ? "s" : ""} na última hora`;
  elRateTextMain.textContent = txt;
  elRateTextSecondary.textContent = txt;
}

/** HISTÓRICO 7D */
function carregarHistorico(){
  try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? (JSON.parse(raw)||[]) : []; }catch{ return []; }
}
function salvarHistorico(hist){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(hist)); }catch{} }
function limparHistoricoAntigo(hist){
  const limite = Date.now() - MILLIS_7D;
  return (hist||[]).filter(e => (e?.registradoEm || 0) >= limite);
}
let historicoEventos = carregarHistorico();

/** CHART */
let chartTopFundos = null;

function atualizarGraficoFundos(ranking){
  if(!ranking || ranking.length === 0){
    elTopFundHeadline.textContent = "Nenhum atraso registrado nos últimos 7 dias";
    elTopFundList.innerHTML = "";
    if(chartTopFundos){ chartTopFundos.destroy(); chartTopFundos = null; }
    return;
  }

  const top = ranking[0];
  elTopFundHeadline.textContent =
    `${abreviarFundo(top.nomeFundo, 34)} — atraso médio de ${formatDurationFromSeconds(top.mediaAtrasoSeg)}`;

  elTopFundList.innerHTML = "";
  ranking.slice(0,5).forEach((f,i)=>{
    const row = document.createElement("div");
    row.className = "topfund-item";
    row.innerHTML = `
      <span class="tf-pos">${i+1}º</span>
      <span class="tf-name" title="${f.nomeFundo}">${abreviarFundo(f.nomeFundo, 22)}</span>
      <span class="tf-delay">${formatDurationFromSeconds(f.mediaAtrasoSeg)}</span>
    `;
    elTopFundList.appendChild(row);
  });

  const ctx = document.getElementById("chartTopFundos").getContext("2d");
  const top5 = ranking.slice(0,5);
  const labels = top5.map(f=>abreviarFundo(f.nomeFundo, 20));
  const data = top5.map(f=>Number((f.mediaAtrasoSeg/60).toFixed(1)));
  const top5Ref = top5.map(f => ({ ...f }));

  if(chartTopFundos) chartTopFundos.destroy();

  chartTopFundos = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ data, borderRadius:8 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            title:(items)=> top5Ref[items[0].dataIndex]?.nomeFundo || items[0].label,
            label:(c)=> `${Number(c.raw).toLocaleString("pt-BR",{minimumFractionDigits:1,maximumFractionDigits:1})} min`
          }
        }
      },
      scales:{
        x:{ ticks:{color:"#9fb4c0",font:{size:9}}, grid:{display:false} },
        y:{ beginAtZero:true, ticks:{color:"#9fb4c0",font:{size:9}}, grid:{color:"rgba(255,255,255,.06)"} }
      }
    }
  });
}

function construirRanking7Dias(){
  historicoEventos = limparHistoricoAntigo(historicoEventos);

  const porFundo = new Map();
  for(const h of historicoEventos){
    if(!h?.nomeFundo) continue;
    const atrasoSeg = h.atrasoSeg || 0;
    if(atrasoSeg <= 0) continue;

    const key = (h.cnpjFundo || h.nomeFundo).toString();
    if(!porFundo.has(key)){
      porFundo.set(key,{ nomeFundo:h.nomeFundo, cnpjFundo:h.cnpjFundo||"", totalAtrasoSeg:0, qtd:0 });
    }
    const agg = porFundo.get(key);
    agg.totalAtrasoSeg += atrasoSeg;
    agg.qtd += 1;
  }

  const ranking = Array.from(porFundo.values())
    .filter(f=>f.qtd>0)
    .map(f=>({ nomeFundo:f.nomeFundo, cnpjFundo:f.cnpjFundo, mediaAtrasoSeg:f.totalAtrasoSeg/f.qtd }))
    .sort((a,b)=>b.mediaAtrasoSeg - a.mediaAtrasoSeg);

  atualizarGraficoFundos(ranking);
}

/** UI */
function renderDelayTop(atrasadas){
  elDelayListTop.innerHTML = "";
  if(!atrasadas.length){
    elDelayListTop.innerHTML = `<div class="delay-item"><span class="delay-op">Nenhuma operação atrasada registrada</span></div>`;
    return;
  }

  const mapOps = new Map();
  for(const ev of atrasadas){
    const key = ev.idOperacaoRecebivel;
    if(!key) continue;
    const cur = mapOps.get(key);
    if(!cur || ev.atrasoSeg > cur.atrasoSeg) mapOps.set(key, ev);
  }

  const ordenadas = Array.from(mapOps.values()).sort((a,b)=>b.atrasoSeg-a.atrasoSeg).slice(0,4);
  const maxAtraso = ordenadas[0]?.atrasoSeg || 1;

  ordenadas.forEach((ev, idx)=>{
    const pct = Math.max(18, (ev.atrasoSeg / maxAtraso) * 100);
    const row = document.createElement("div");
    row.className = "delay-item";
    row.innerHTML = `
      <div class="delay-header">
        <span class="delay-op">Operação ${ev.idOperacaoRecebivel}</span>
        <span class="delay-rank">#${idx+1}</span>
      </div>
      <div class="delay-meter">
        <div class="delay-bar-outer">
          <div class="delay-bar-inner" style="width:${pct.toFixed(1)}%"></div>
        </div>
        <span class="delay-time">${ev.atrasoStr}</span>
      </div>
      <div class="delay-status">Assinatura Pendente</div>
    `;
    elDelayListTop.appendChild(row);
  });
}

function renderTabela(eventos){
  elTable.innerHTML = "";
  if(!eventos.length){
    elTable.innerHTML = `
      <div class="row">
        <span class="pill">—</span>
        <div>
          <div style="font-weight:900">Nenhuma assinatura pendente</div>
          <div class="small">Aguardando eventos</div>
        </div>
        <span class="badge ok">OK</span>
        <div style="text-align:right;font-weight:900">00:00:00</div>
      </div>`;
    return;
  }

  eventos
    .slice()
    .sort((a,b)=>(b.atrasoSeg||0)-(a.atrasoSeg||0))
    .slice(0, 30)
    .forEach(ev=>{
      const isLate = (ev.atrasoSeg||0) > 0;
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <span class="pill">${ev.horario || "--:--:--"}</span>
        <div>
          <div style="font-weight:900">${abreviarFundo(ev.nomeFundo||"", 28)}</div>
          <div class="small">Operação ${ev.idOperacaoRecebivel} · CNPJ ${formatCnpj(ev.cnpjFundo)}</div>
        </div>
        <span class="badge ${isLate ? "danger" : "ok"}">${isLate ? "PENDENTE" : "OK"}</span>
        <div style="text-align:right;font-variant-numeric:tabular-nums;font-weight:900">${ev.atrasoStr || "00:00:00"}</div>
      `;
      elTable.appendChild(row);
    });
}

/** FETCH */
async function carregarEventosReais(){
  try{
    elPanelStatus.textContent = "Carregando…";

    const res = await fetch(API_URL, {
      cache:"no-store",
      headers:{
        "Ambiente": CFG.amb,
        "Token": CFG.token
      }
    });

    if(!res.ok){
      elPanelStatus.textContent = `Erro HTTP ${res.status}`;
      console.error("Falha ao buscar dados", res.status, await res.text());
      renderTabela([]);
      return;
    }

    const json = await res.json();

    let eventos = [];
    if (Array.isArray(json)) eventos = json;
    else if (json && Array.isArray(json.data)) eventos = json.data;
    else if (json && json.data) eventos = [json.data];

    const atrasadas = [];
    const now = new Date();
    const nowMs = now.getTime();
    let eventosUltimaHora = 0;

    for(const ev of eventos){
      const atrasoRaw = (ev.hrAtraso || "00:00:00").toString().trim();
      const [ah,am,as] = atrasoRaw.split(":");
      const hh = Number(ah)||0, mm = Number(am)||0, ss = Number(as)||0;
      const atrasoSeg = hh*3600 + mm*60 + ss;
      const atrasoStr = `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;

      ev.atrasoSeg = atrasoSeg;
      ev.atrasoStr = atrasoStr;

      if(atrasoSeg>0) atrasadas.push(ev);

      const partes = (ev.horario || "00:00:00").split(":").map(Number);
      const ts = new Date(now.getFullYear(), now.getMonth(), now.getDate(), partes[0]||0, partes[1]||0, partes[2]||0).getTime();
      if(nowMs - ts <= 60*60*1000) eventosUltimaHora++;
    }

    const qtd = eventos.length;
    const atual = Number((elTotal.textContent || "0").replace(/\./g,"")) || 0;
    animateCount(elTotal, atual, qtd);
    elSub.textContent = qtd === 1 ? "1 assinatura exibida" : `${qtd.toLocaleString("pt-BR")} assinaturas exibidas`;

    elFooterRateText.textContent =
      eventosUltimaHora === 0 ? "Nenhum evento na última hora" : `${eventosUltimaHora} evento${eventosUltimaHora !== 1 ? "s" : ""} na última hora`;
    elFooterRateSecondary.textContent = "Painel atualizado em tempo real";
    elPanelStatus.textContent = `OK · ${new Date().toLocaleTimeString("pt-BR")}`;

    updateGauge(eventosUltimaHora);
    renderDelayTop(atrasadas);
    renderTabela(eventos);

    historicoEventos = limparHistoricoAntigo(historicoEventos);
    for(const ev of atrasadas){
      const keyHist = `${ev.idOperacaoRecebivel || ""}-${ev.cnpjFundo || ""}`;
      const idx = historicoEventos.findIndex(h => h.key === keyHist);
      if(idx === -1){
        historicoEventos.push({
          key: keyHist,
          nomeFundo: ev.nomeFundo || "Fundo não identificado",
          cnpjFundo: ev.cnpjFundo || "",
          atrasoSeg: ev.atrasoSeg || 0,
          registradoEm: Date.now()
        });
      } else {
        historicoEventos[idx].atrasoSeg = ev.atrasoSeg || 0;
        historicoEventos[idx].registradoEm = Date.now();
      }
    }
    salvarHistorico(historicoEventos);
    construirRanking7Dias();

  } catch(e){
    elPanelStatus.textContent = "Erro (ver console)";
    console.error("Erro ao carregar eventos", e);
    renderTabela([]);
  }
}

(function init(){
  construirRanking7Dias();
  carregarEventosReais();
  setInterval(carregarEventosReais, 20000);
})();
</script>
</body>
</html>
