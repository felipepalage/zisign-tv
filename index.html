<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ZiSign TV</title>
<link rel="icon" type="image/png" href="img/ZiSignPNG.png"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet"/>

<style>
  :root{
    --bg:#050609;
    --grad-a:#071e18;
    --grad-b:#061527;
    --panel:#0c1116;
    --panel-soft:#121922;
    --border:rgba(0,255,194,.18);
    --border-soft:rgba(255,255,255,.06);
    --text:#f4f8f7;
    --muted:#9fb4c0;
    --accent:#00f0c0;
    --accent-soft:#00d187;
    --danger:#ff5c7a;
    --warn:#ffc96a;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 90% -10%, var(--grad-a) 0%, transparent 60%),
      radial-gradient(900px 700px at 10% 110%, var(--grad-b) 0%, transparent 60%),
      linear-gradient(180deg,#050609 0%,#05070a 45%,#050508 100%);
    overflow:hidden;
    font-size:14px;
  }

  .stage{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:transparent;
  }

  .scale-wrap{
    width:1920px;
    height:1080px;
    position:relative;
    transform-origin:top left;
  }

  #fx{
    position:absolute;
    inset:0;
    z-index:0;
    pointer-events:none;
    opacity:.5;
    filter:blur(0.3px);
  }

  .wrap{
    position:relative;
    z-index:1;
    height:100%;
    padding:16px 18px;
    display:grid;
    grid-template-rows:90px 1.5fr 1.1fr 120px;
    row-gap:14px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    background:linear-gradient(135deg,rgba(12,17,22,.95),rgba(12,17,22,.94));
    border-radius:16px;
    padding:10px 18px;
    border:1px solid var(--border-soft);
    box-shadow:0 18px 50px rgba(0,0,0,.6),0 0 0 1px rgba(0,0,0,.5);
  }
  .brand{
    display:flex;
    align-items:center;
    gap:18px;
  }
  .brand img{
    height:80px;
    width:auto;
  }
  .brand-info{
    display:flex;
    flex-direction:column;
    gap:3px;
  }
  .brand-title{
    font-weight:800;
    font-size:16px;
    letter-spacing:.05em;
    text-transform:uppercase;
  }
  .brand-sub{
    font-size:12px;
    color:var(--muted);
    opacity:.9;
  }
  .clock{
    font-weight:700;
    letter-spacing:.14em;
    font-size:14px;
    color:var(--accent);
    padding:6px 14px;
    border-radius:999px;
    border:1px solid rgba(0,255,194,.35);
    background:radial-gradient(circle at 0 50%,rgba(0,255,194,.12),transparent 65%);
    white-space:nowrap;
  }
  .controls{display:none !important;}

  .top-grid{
    display:grid;
    grid-template-columns:1.05fr 1.05fr 1.3fr;
    gap:14px;
    min-height:0;
  }
  .card{
    background:
      radial-gradient(circle at 0 0,rgba(0,255,194,.08),transparent 55%),
      radial-gradient(circle at 100% 100%,rgba(0,128,255,.06),transparent 55%),
      linear-gradient(180deg,var(--panel) 0%,#080c11 100%);
    border-radius:16px;
    border:1px solid var(--border-soft);
    box-shadow:0 18px 60px rgba(0,0,0,.7);
    padding:12px 18px;
    display:flex;
    flex-direction:column;
    gap:6px;
    min-height:0;
  }
  .card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--muted);
    opacity:.95;
  }
  .card-header span.label-pill{
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(0,255,194,.22);
    color:var(--accent);
    font-weight:600;
    white-space:nowrap;
  }

  .total-wrap{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .total-main{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .total-value{
    font-size:44px;
    line-height:1;
    font-weight:800;
  }
  .total-sub{
    font-size:13px;
    color:var(--muted);
  }
  .total-badge{
    font-size:12px;
    font-weight:600;
    color:#061017;
    background:linear-gradient(135deg,var(--accent),var(--accent-soft));
    padding:6px 10px;
    border-radius:999px;
    box-shadow:0 10px 28px rgba(0,255,194,.45);
  }
  .total-pill{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:6px;
  }
  .total-label-small{
    font-size:12px;
    color:var(--muted);
  }

  .gauge-main{
    flex:1;
    display:grid;
    place-items:center;
  }
  .ring{
    width:100%;
    max-width:220px;
    aspect-ratio:1/1;
    position:relative;
  }
  .ring svg{
    width:100%;
    height:100%;
    transform:rotate(-90deg);
  }
  .ring .value{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
    text-align:center;
  }
  .ring .value-num{
    font-size:32px;
    font-weight:800;
  }

  .topfund-main{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:0;
  }
  .topfund-headline{
    font-size:13px;
    font-weight:700;
  }
  .topfund-chart-wrap{
    flex:1;
    min-height:180px;
    border-radius:12px;
    background:radial-gradient(circle at 0 100%,rgba(0,255,194,.08),transparent 65%);
    border:1px solid rgba(255,255,255,.06);
    padding:6px 8px;
  }
  .topfund-chart-wrap canvas{
    width:100% !important;
    height:100% !important;
  }
  .topfund-list{
    display:flex;
    flex-direction:column;
    gap:3px;
    font-size:12px;
  }
  .topfund-item{
    display:grid;
    grid-template-columns:auto 1fr auto;
    align-items:center;
    gap:6px;
  }
  .tf-pos{
    font-weight:700;
    color:var(--accent);
    min-width:26px;
  }
  .tf-name{
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    color:var(--text);
  }
  .tf-delay{
    color:var(--muted);
    font-weight:600;
  }

  .mid-grid{
    display:grid;
    grid-template-columns:2fr 0.9fr;
    gap:14px;
    min-height:0;
    align-items:stretch;
  }

  .ticker{
    background:linear-gradient(180deg,var(--panel-soft) 0%,#080b10 100%);
    border-radius:16px;
    border:1px solid var(--border-soft);
    box-shadow:0 16px 55px rgba(0,0,0,.7);
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .ticker-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px 14px 10px;
    font-size:12px;
    color:var(--muted);
    letter-spacing:.12em;
    text-transform:uppercase;
  }
  .ticker-body{
    border-top:1px solid rgba(255,255,255,.06);
    overflow:hidden;
    position:relative;
  }
  .ticker-row{
    display:flex;
    align-items:center;
    gap:20px;
    white-space:nowrap;
    padding:10px 0;
    animation:scrollX 38s linear infinite;
  }
  .ticker:hover .ticker-row{animation-play-state:paused;}
  .tick{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 14px;
    margin-left:10px;
    border-radius:999px;
    background:rgba(14,26,34,.95);
    border:1px solid rgba(0,255,194,.18);
    font-size:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.7);
  }
  .pill{
    padding:4px 10px;
    border-radius:999px;
    background:rgba(0,255,194,.12);
    border:1px solid rgba(0,255,194,.55);
    font-size:12px;
    color:var(--accent);
    font-weight:600;
  }

  @keyframes scrollX{
    0%{transform:translateX(100%)}
    100%{transform:translateX(-100%)}
  }

  .h-card{
    background:linear-gradient(180deg,var(--panel-soft) 0%,#080b10 100%);
    border-radius:14px;
    border:1px solid var(--border-soft);
    box-shadow:0 12px 40px rgba(0,0,0,.7);
    display:flex;
    flex-direction:column;
    padding:10px 14px;
    max-height:none;
  }
  .h-title{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.16em;
    color:var(--muted);
    margin-bottom:6px;
  }
  .delay-list{
    flex:1;
    min-height:0;
    overflow:hidden;
    position:relative;
    margin-top:2px;
  }
  .delay-track{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .delay-item{
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:11px;
  }
  .delay-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .delay-op{
    color:var(--text);
    font-weight:600;
    opacity:.95;
  }
  .delay-rank{
    font-size:10px;
    color:var(--muted);
    opacity:.85;
  }
  .delay-meter{
    display:grid;
    grid-template-columns:1fr auto;
    align-items:center;
    gap:8px;
  }
  .delay-bar-outer{
    position:relative;
    width:100%;
    height:6px;
    border-radius:999px;
    background:rgba(255,255,255,.06);
    overflow:hidden;
  }
  .delay-bar-inner{
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:linear-gradient(90deg,var(--danger),#ff8b8b);
  }
  .delay-time{
    font-variant-numeric:tabular-nums;
    color:var(--muted);
    font-size:11px;
  }
  .delay-status{
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--danger);
    opacity:.9;
  }

  footer{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:16px;
    font-size:11px;
    color:var(--muted);
    opacity:.9;
    width:100%;
    padding:10px 14px;
    background:linear-gradient(180deg,var(--panel-soft) 0%,#080b10 100%);
    border:1px solid var(--border-soft);
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,.7);
  }

  .toast{
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:30;
    min-width:260px;
    max-width:360px;
    background:linear-gradient(180deg,#101722,#090d13);
    border-radius:14px;
    border:1px solid rgba(0,255,194,.25);
    box-shadow:0 20px 60px rgba(0,0,0,.8);
    transform:translateY(20px);
    opacity:0;
    pointer-events:none;
    display:none;
  }
  .toast-inner{padding:10px 12px;font-size:12px;}
  .toast.show{display:block;animation:toastIn .25s ease-out forwards;}
  .toast.hide{animation:toastOut .2s ease-in forwards;}
  @keyframes toastIn{to{transform:translateY(0);opacity:1}}
  @keyframes toastOut{to{transform:translateY(14px);opacity:0}}

  #fx{display:none !important;}
</style>
</head>
<body>

<div class="stage">
  <div class="scale-wrap">
    <canvas id="fx"></canvas>

    <div class="wrap">
      <header>
        <div class="brand">
          <img src="img/ZiSignPNG.png" alt="ZiSign"/>
          <div class="brand-info"></div>
        </div>
        <div class="clock" id="clock">--:--:--</div>
        <div class="controls"></div>
      </header>

      <section class="top-grid">
        <article class="card">
          <div class="card-header">
            <span>Visão geral</span>
            <span class="label-pill">Total de assinaturas exibidas</span>
          </div>
          <div class="total-wrap">
            <div class="total-main">
              <div class="total-value" id="totalCount">0</div>
              <div class="total-sub" id="subCount">—</div>
            </div>
            <div class="total-pill">
              <div class="total-label-small">Status do painel</div>
              <div class="total-badge">Atualizado em tempo real</div>
            </div>
          </div>
        </article>

        <article class="card">
          <div class="card-header">
            <span>Ritmo de assinaturas</span>
            <span class="label-pill" id="rateTextMain">—</span>
          </div>
          <div class="gauge-main">
            <div class="ring">
              <svg viewBox="0 0 120 120" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#00ffc2"/>
                    <stop offset="100%" stop-color="#00b8ff"/>
                  </linearGradient>
                </defs>
                <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="10" />
                <circle id="arc" cx="60" cy="60" r="50" fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" stroke-dasharray="0 999" />
              </svg>
              <div class="value">
                <div class="value-num" id="rateNum">0</div>
              </div>
            </div>
          </div>
        </article>

        <article class="card">
          <div class="card-header">
            <span>Fundos que mais atrasam</span>
            <span class="label-pill">Atraso médio (últimos 7 dias)</span>
          </div>
          <div class="topfund-main">
            <div class="topfund-headline" id="topFundHeadline">Nenhum atraso registrado</div>
            <div class="topfund-chart-wrap">
              <canvas id="chartTopFundos"></canvas>
            </div>
            <div class="topfund-list" id="topFundList"></div>
          </div>
        </article>
      </section>

      <section class="mid-grid">
        <article class="ticker" aria-live="polite">
          <div class="ticker-head">
            <span>Últimas assinaturas processadas</span>
            <span id="rateTextSecondary" style="opacity:.9;font-size:inherit;"></span>
          </div>
          <div class="ticker-body">
            <div class="ticker-row" id="tickerRow"></div>
          </div>
        </article>

        <aside class="h-card">
          <div class="h-title">Top operações com maior atraso</div>
          <div class="delay-list">
            <div class="delay-track" id="delayList"></div>
          </div>
        </aside>
      </section>

      <footer>
        <div style="min-width:260px; display:flex; flex-direction:column; gap:4px;">
          <div style="
            font-size:10px;
            text-transform:uppercase;
            letter-spacing:.16em;
            opacity:.8;
          ">
            Últimas assinaturas processadas
          </div>
          <div id="footerRateText" style="font-size:12px; opacity:.9;"></div>
          <div id="footerRateSecondary" style="font-size:11px; opacity:.75;"></div>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <div style="
            font-size:10px;
            text-transform:uppercase;
            letter-spacing:.16em;
            opacity:.8;
          ">
            Top operações com maior atraso
          </div>

          <div class="delay-list" style="max-height:70px; overflow:hidden;">
            <div class="delay-track" id="delayListFooter"></div>
          </div>
        </div>

        <div style="
          white-space:nowrap;
          font-size:11px;
          opacity:.75;
          align-self:flex-end;
        ">
          contato@zisign.ai — © 2025 ZiSign
        </div>
      </footer>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="assertive" aria-atomic="true">
  <div class="toast-inner" id="toastContent"></div>
</div>

<audio id="ding" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
</audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function aplicarScale(){
  const baseW = 1920;
  const baseH = 1080;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const scale = Math.min(vw/baseW, vh/baseH);
  const el = document.querySelector(".scale-wrap");
  if(el){
    el.style.transform = "scale(" + scale + ")";
  }
}
window.addEventListener("resize", aplicarScale);
aplicarScale();

function atualizarFooter(eventosUltimaHora, atrasadas) {
  const footerRate = document.getElementById("footerRateText");
  const footerDelayList = document.getElementById("delayListFooter");
  const footerRateSecondary = document.getElementById("footerRateSecondary");

  if (footerRate) {
    footerRate.textContent =
      eventosUltimaHora === 0
        ? "Nenhum evento na última hora"
        : `${eventosUltimaHora} evento${eventosUltimaHora !== 1 ? "s" : ""} na última hora`;
  }

  if (footerRateSecondary) {
    footerRateSecondary.textContent =
      eventosUltimaHora === 0
        ? "Aguardando novas assinaturas"
        : "Painel atualizado em tempo real";
  }

  if (!footerDelayList) return;

  footerDelayList.innerHTML = "";

  if (!atrasadas.length) {
    footerDelayList.innerHTML =
      `<div class="delay-item">
         <span class="delay-op">Nenhuma operação atrasada registrada</span>
       </div>`;
    return;
  }

  const ordenado = atrasadas
    .slice()
    .sort((a, b) => b.atrasoSeg - a.atrasoSeg)
    .slice(0, 4);

  ordenado.forEach(ev => {
    const row = document.createElement("div");
    row.className = "delay-item";
    row.innerHTML = `
      <span class="delay-op">Operação ${ev.idOperacaoRecebivel}</span>
      <span class="delay-late">${ev.atrasoStr} · Assinatura Pendente</span>
    `;
    footerDelayList.appendChild(row);
  });
}

(() => {
  const c = document.getElementById("fx");
  const ctx = c.getContext("2d");
  let w, h, dpr;
  function resize(){
    dpr = window.devicePixelRatio || 1;
    w = c.clientWidth;
    h = c.clientHeight;
    c.width = w*dpr;
    c.height = h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  const N = 80;
  const pts = [];
  for(let i=0;i<N;i++){
    pts.push({
      x: Math.random()*w,
      y: Math.random()*h,
      r: Math.random()*1.8+0.5,
      a: Math.random()*Math.PI*2,
      sp: .15 + Math.random()*.6,
      hue: 160 + Math.random()*60
    });
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for(const p of pts){
      p.a += (Math.random()-.5)*.08;
      p.x += Math.cos(p.a)*p.sp;
      p.y += Math.sin(p.a)*p.sp;

      if(p.x<-20) p.x=w+20;
      if(p.x>w+20) p.x=-20;
      if(p.y<-20) p.y=h+20;
      if(p.y>h+20) p.y=-20;

      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*5);
      g.addColorStop(0, `hsla(${p.hue},100%,60%,.18)`);
      g.addColorStop(1, `hsla(${p.hue},100%,60%,0)`);
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r*5,0,Math.PI*2);
      ctx.fill();

      ctx.fillStyle = `hsla(${p.hue},100%,70%,.55)`;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  tick();
})();

const CNPJ_CERTIFICADORA = "54638076000176";
const API_BASE = "https://custodiabackend-staging.idsf.com.br";
const API_URL = `${API_BASE}/api/ZiSign/TV?cnpjCertificadora=${CNPJ_CERTIFICADORA}`;

const STORAGE_KEY = "zisign_tv_hist_7d";
const MILLIS_7D = 7 * 24 * 60 * 60 * 1000;

function carregarHistorico(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    console.warn("Erro ao carregar histórico", e);
    return [];
  }
}
function salvarHistorico(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(historicoEventos));
  }catch(e){
    console.warn("Erro ao salvar histórico", e);
  }
}
function limparHistoricoAntigo(){
  const limite = Date.now() - MILLIS_7D;
  historicoEventos = historicoEventos.filter(e => (e.registradoEm || 0) >= limite);
}

let historicoEventos = carregarHistorico();

let soundOn = true;
let toastOn = true;

const elClock   = document.getElementById("clock");
const elTotal   = document.getElementById("totalCount");
const elSub     = document.getElementById("subCount");
const elTicker  = document.getElementById("tickerRow");
const elRateTextMain = document.getElementById("rateTextMain");
const elRateTextSecondary = document.getElementById("rateTextSecondary");
const elRateNum = document.getElementById("rateNum");
const elToast   = document.getElementById("toast");
const elToastContent = document.getElementById("toastContent");
const audioDing = document.getElementById("ding");
const arc       = document.getElementById("arc");
const elDelayList = document.getElementById("delayList");
const elTopFundHeadline = document.getElementById("topFundHeadline");
const elTopFundList = document.getElementById("topFundList");

const pad2 = n => (n<10 ? "0"+n : ""+n);
const formatCnpj = cnpj => {
  const d = (cnpj || "").toString().replace(/\D/g,"");
  if (d.length !== 14) return cnpj || "";
  return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,"$1.$2.$3/$4-$5");
};
const formatDurationFromSeconds = totalSeconds => {
  const s = Math.max(0, Math.floor(totalSeconds || 0));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
};
const abreviarFundo = (nome, max=20) => {
  if(!nome) return "";
  const n = nome.trim();
  if(n.length <= max) return n;
  return n.slice(0, max-1) + "…";
};

function animateCount(el, from, to, duration=600){
  const start = performance.now();
  function step(ts){
    const p = Math.min(1, (ts-start)/duration);
    const val = Math.round(from + (to-from)*p);
    el.textContent = val.toLocaleString("pt-BR");
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

setInterval(()=>{
  const d = new Date();
  elClock.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}, 1000);

let toastTimeout = null;
function showToast(html){
  if(!toastOn) return;
  elToastContent.innerHTML = html;
  elToast.classList.remove("hide");
  elToast.classList.add("show");
  elToast.style.pointerEvents="auto";
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(hideToast, 6500);
}
function hideToast(){
  elToast.classList.remove("show");
  elToast.classList.add("hide");
  elToast.style.pointerEvents="none";
  setTimeout(()=>{
    elToast.classList.remove("hide");
    elToast.style.display="none";
  }, 220);
}
document.addEventListener("click", (e)=>{
  if(!elToast.contains(e.target)) hideToast();
});

function updateGauge(val){
  const max = 60;
  const pct = Math.max(0, Math.min(1, val/max));
  const C = 2 * Math.PI * 50;
  const dash = (C * pct).toFixed(1);
  arc.setAttribute("stroke-dasharray", `${dash} ${Math.max(0,C-dash).toFixed(1)}`);
  elRateNum.textContent = val.toFixed(0);
  const txt = `${val} evento${val !== 1 ? "s" : ""} na última hora`;
  if (elRateTextMain) elRateTextMain.textContent = txt;
  if (elRateTextSecondary) elRateTextSecondary.textContent = txt;
}

let chartTopFundos = null;

function atualizarGraficoFundos(ranking){
  if(!elTopFundHeadline || !elTopFundList) return;

  if(!ranking || ranking.length === 0){
    elTopFundHeadline.textContent = "Nenhum atraso registrado nos últimos 7 dias";
    elTopFundList.innerHTML = "";
    if(chartTopFundos){
      chartTopFundos.destroy();
      chartTopFundos = null;
    }
    return;
  }

  const top = ranking[0];
  elTopFundHeadline.textContent =
    `${abreviarFundo(top.nomeFundo, 32)} — atraso médio de ${formatDurationFromSeconds(top.mediaAtrasoSeg)}`;

  elTopFundList.innerHTML = "";
  ranking.slice(0,5).forEach((f,i)=>{
    const row = document.createElement("div");
    row.className = "topfund-item";
    row.innerHTML = `
      <span class="tf-pos">${i+1}º</span>
      <span class="tf-name" title="${f.nomeFundo}">${abreviarFundo(f.nomeFundo, 22)}</span>
      <span class="tf-delay">${formatDurationFromSeconds(f.mediaAtrasoSeg)}</span>
    `;
    elTopFundList.appendChild(row);
  });

  const ctx = document.getElementById("chartTopFundos").getContext("2d");
  const top5 = ranking.slice(0,5);
  const labels = top5.map(f=>abreviarFundo(f.nomeFundo, 20));
  const data = top5.map(f=>Number((f.mediaAtrasoSeg/60).toFixed(1)));
  const top5Ref = top5.map(f => ({ ...f }));

  if(chartTopFundos){
    chartTopFundos.destroy();
  }

  chartTopFundos = new Chart(ctx, {
    type:"bar",
    data:{
      labels,
      datasets:[{
        data,
        borderRadius:8
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            title:(items)=>{
              const idx = items[0].dataIndex;
              return top5Ref[idx]?.nomeFundo || items[0].label;
            },
            label:(context)=>{
              const v = context.raw;
              return `${v.toLocaleString("pt-BR",{minimumFractionDigits:1,maximumFractionDigits:1})} min`;
            }
          }
        }
      },
      scales:{
        x:{
          ticks:{color:"#9fb4c0",font:{size:9}},
          grid:{display:false}
        },
        y:{
          beginAtZero:true,
          ticks:{color:"#9fb4c0",font:{size:9}},
          grid:{color:"rgba(255,255,255,.06)"}
        }
      }
    }
  });
}

function construirRanking7Dias(){
  limparHistoricoAntigo();

  const porFundoHist = new Map();

  historicoEventos.forEach(h=>{
    if(!h || !h.nomeFundo) return;
    const atrasoSeg = h.atrasoSeg || 0;
    if(atrasoSeg <= 0) return;

    const keyF = (h.cnpjFundo || h.nomeFundo).toString();
    if(!porFundoHist.has(keyF)){
      porFundoHist.set(keyF,{
        nomeFundo: h.nomeFundo,
        cnpjFundo: h.cnpjFundo || "",
        totalAtrasoSeg: 0,
        qtd: 0
      });
    }
    const agg = porFundoHist.get(keyF);
    agg.totalAtrasoSeg += atrasoSeg;
    agg.qtd += 1;
  });

  const rankingFundos = Array.from(porFundoHist.values())
    .filter(f=>f.qtd > 0)
    .map(f=>({
      nomeFundo: f.nomeFundo,
      cnpjFundo: f.cnpjFundo,
      mediaAtrasoSeg: f.totalAtrasoSeg / f.qtd
    }))
    .sort((a,b)=>b.mediaAtrasoSeg - a.mediaAtrasoSeg);

  atualizarGraficoFundos(rankingFundos);
}

async function carregarEventosReais(){
  try{
    const res = await fetch(API_URL, { cache:"no-store", mode:"cors" });
    if(!res.ok){
      console.error("Falha ao buscar dados", res.status);
      return;
    }

    const json = await res.json();

    let eventos = [];
    if (Array.isArray(json)) {
      eventos = json;
    } else if (json && Array.isArray(json.data)) {
      eventos = json.data;
    } else if (json && json.data) {
      eventos = [json.data];
    }

    const qtd = eventos.length;
    const atual = Number(elTotal.textContent.replace(/\./g,"")) || 0;
    animateCount(elTotal, atual, qtd);
    elSub.textContent = qtd === 1 ? "1 assinatura exibida" : `${qtd.toLocaleString("pt-BR")} assinaturas exibidas`;

    elTicker.innerHTML = "";
    elDelayList.innerHTML = "";

    const now = new Date();
    const nowMs = now.getTime();
    let eventosUltimaHora = 0;

    const atrasadas = [];

    eventos.forEach(ev=>{
      const atrasoRaw = ev.hrAtraso || "00:00:00";
      const partesAtraso = atrasoRaw.split(":");
      const ah = parseInt(partesAtraso[0] || "0", 10);
      const am = parseInt(partesAtraso[1] || "0", 10);
      const as = parseInt(partesAtraso[2] || "0", 10);
      const hh = isNaN(ah) ? 0 : ah;
      const mm = isNaN(am) ? 0 : am;
      const ss = isNaN(as) ? 0 : as;
      const atrasoSeg = hh*3600 + mm*60 + ss;
      const atrasoStr = `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;

      if(atrasoSeg > 0){
        const keyHist = `${ev.idOperacaoRecebivel || ""}-${ev.cnpjFundo || ""}`;
        const idx = historicoEventos.findIndex(h => h.key === keyHist);
        if(idx === -1){
          historicoEventos.push({
            key: keyHist,
            nomeFundo: ev.nomeFundo || "Fundo não identificado",
            cnpjFundo: ev.cnpjFundo || "",
            atrasoSeg: atrasoSeg,
            registradoEm: Date.now()
          });
        } else {
          historicoEventos[idx].atrasoSeg = atrasoSeg;
          historicoEventos[idx].registradoEm = Date.now();
        }

        atrasadas.push({
          ...ev,
          atrasoStr,
          atrasoSeg
        });
      }

      const div = document.createElement("div");
      div.className = "tick";
      div.innerHTML = `
        <span class="pill">${ev.horario}</span>
        <span title="${ev.nomeFundo || ""}"><strong>${abreviarFundo(ev.nomeFundo || "", 20)}</strong></span>
        <span style="opacity:.9">Operação: ${ev.idOperacaoRecebivel} · CNPJ ${formatCnpj(ev.cnpjFundo)} · Atraso ${atrasoStr}</span>
      `;
      elTicker.appendChild(div);

      const partes = (ev.horario || "00:00:00").split(":").map(Number);
      const hhEv = partes[0] || 0;
      const mmEv = partes[1] || 0;
      const ssEv = partes[2] || 0;
      const ts = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hhEv, mmEv, ssEv).getTime();
      if(nowMs - ts <= 60*60*1000) eventosUltimaHora++;
    });

    updateGauge(eventosUltimaHora);
    atualizarFooter(eventosUltimaHora, atrasadas);

    if (atrasadas.length > 0){
      atrasadas.sort((a,b)=>b.atrasoSeg - a.atrasoSeg);
      const topOps = atrasadas.slice(0, 4);
      const maxAtraso = topOps[0].atrasoSeg || 1;

      topOps.forEach((ev, idx)=>{
        const row = document.createElement("div");
        row.className = "delay-item";

        const pct = Math.max(18, (ev.atrasoSeg / maxAtraso) * 100);

        row.innerHTML = `
          <div class="delay-header">
            <span class="delay-op">Operação ${ev.idOperacaoRecebivel}</span>
            <span class="delay-rank">#${idx+1}</span>
          </div>
          <div class="delay-meter">
            <div class="delay-bar-outer">
              <div class="delay-bar-inner" style="width:${pct.toFixed(1)}%"></div>
            </div>
            <span class="delay-time">${ev.atrasoStr}</span>
          </div>
          <div class="delay-status">Assinatura Pendente</div>
        `;
        elDelayList.appendChild(row);
      });
    } else {
      const row = document.createElement("div");
      row.className = "delay-item";
      row.innerHTML = `<span class="delay-op">Nenhuma operação atrasada registrada</span>`;
      elDelayList.appendChild(row);
    }

    limparHistoricoAntigo();
    salvarHistorico();
    construirRanking7Dias();

    if(qtd > 0){
      const last = eventos[eventos.length - 1];
      const atrasoLastRaw = last.hrAtraso || "00:00:00";
      const partesLast = atrasoLastRaw.split(":");
      const ahL = parseInt(partesLast[0] || "0", 10);
      const amL = parseInt(partesLast[1] || "0", 10);
      const asL = parseInt(partesLast[2] || "0", 10);
      const atrasoLast = `${pad2(isNaN(ahL)?0:ahL)}:${pad2(isNaN(amL)?0:amL)}:${pad2(isNaN(asL)?0:asL)}`;

      showToast(`
        <div style="display:grid;gap:4px">
          <div><strong>${last.nomeFundo}</strong></div>
          <div>Operação ${last.idOperacaoRecebivel}</div>
          <div style="opacity:.9">CNPJ ${formatCnpj(last.cnpjFundo)}</div>
          <div style="opacity:.8">Atraso: ${atrasoLast}</div>
          <div style="opacity:.7">Atualizado às ${last.horario}</div>
        </div>
      `);
      if (document.hasFocus() && soundOn){
        try{
          audioDing.currentTime = 0;
          audioDing.play().catch(()=>{});
        }catch{}
      }
    }

  } catch(e){
    console.error("Erro ao carregar eventos", e);
  }
}

(function init(){
  construirRanking7Dias();
  carregarEventosReais();
  setInterval(carregarEventosReais, 20000);
})();
</script>
</body>
</html>
