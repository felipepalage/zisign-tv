<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ZiSign TV</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet"/>

<style>
:root{
  --bg0:#05070b; --bg1:#070c12;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.10);
  --muted:rgba(255,255,255,.65);
  --text:rgba(255,255,255,.92);
  --accent:#00f0c0; --danger:#ff5c7a;
  --shadow:0 22px 70px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Montserrat',system-ui;
  background:linear-gradient(180deg,var(--bg0),var(--bg1));
  color:var(--text);
}

/* GRID */
.wrap{height:100vh;max-width:2560px;margin:auto;padding:12px;display:grid;gap:12px}
header{display:flex;justify-content:space-between;align-items:center}

/* DASH */
.dash{
  display:grid;
  gap:12px;
  grid-template-columns:360px 1fr 1fr;
  grid-template-rows:320px 360px;
  grid-template-areas:
    "side donut bars"
    "side area ticker";
}

/* CARD */
.card{
  border-radius:22px;
  background:var(--card);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  backdrop-filter:blur(12px);
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:0;
}

/* TITLES */
.title{font-weight:900;font-size:.8rem;text-transform:uppercase;color:rgba(255,255,255,.75)}
.pill{padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.10);font-weight:900;font-size:.75rem}

/* LEFT */
.side{grid-area:side}
.kpiBox{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(0,0,0,.2)}
.kpiVal{font-size:2rem;font-weight:900}

/* ATRASOS */
.delayWrap{flex:1;display:flex;flex-direction:column;gap:10px;min-height:0}
.delay-list{height:260px;overflow:hidden;display:flex;flex-direction:column}
.delay-pinned{display:flex;flex-direction:column;gap:8px}
.delay-scroll{flex:1;overflow:hidden}
.delay-track{display:flex;flex-direction:column;gap:8px;will-change:transform}
.delay-item{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2)}
.delay-time{color:var(--muted);font-weight:900;font-size:.85rem}
.bar{height:6px;border-radius:99px;background:rgba(255,255,255,.1);overflow:hidden}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,#ff5c7a,#ff9aa9)}

/* CHARTS */
.chartArea{flex:1;border-radius:16px;border:1px solid rgba(255,255,255,.1);padding:10px;background:rgba(0,0,0,.2)}

/* PENDÊNCIAS */
.ticker{grid-area:ticker;display:flex;flex-direction:column;min-height:0;padding:0}
.tickerHead{padding:12px;border-bottom:1px solid rgba(255,255,255,.1)}
.table{
  flex:1;
  min-height:0;
  overflow:auto;
  padding:12px;
  display:grid;
  gap:10px;
}

/* ROW */
.row{
  display:grid;
  grid-template-columns:90px 1fr 120px 120px;
  gap:10px;
  align-items:center;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(0,0,0,.25)
}
.time{font-weight:900}
.tag{padding:6px 12px;border-radius:99px;font-weight:900;font-size:.75rem}
.tag.bad{color:#ff5c7a;border:1px solid #ff5c7a}
.tag.ok{color:#00f0c0;border:1px solid #00f0c0}
</style>
</head>

<body>
<div class="wrap">

<header>
  <strong>ZiSign</strong>
  <div id="clock" class="pill">--:--:--</div>
</header>

<section class="dash">

<!-- LEFT -->
<article class="card side">
  <div class="title">Visão geral</div>

  <div class="kpiBox">
    <div>Total Pendências</div>
    <div class="kpiVal" id="totalCount">0</div>
  </div>

  <div class="kpiBox">
    <div>Ritmo (hora)</div>
    <div class="kpiVal" id="rateNum">0</div>
  </div>

  <div class="delayWrap">
    <div class="title">Maiores atrasos</div>
    <div class="delay-list">
      <div class="delay-pinned" id="delayPinned"></div>
      <div class="delay-scroll"><div class="delay-track" id="delayListTop"></div></div>
    </div>
  </div>
</article>

<!-- DONUT -->
<article class="card donut">
  <div class="title">Pendências por status</div>
  <div class="chartArea"><canvas id="chartDonut"></canvas></div>
</article>

<!-- BARS -->
<article class="card bars">
  <div class="title">Eventos por hora</div>
  <div class="chartArea"><canvas id="chartBars"></canvas></div>
</article>

<!-- AREA -->
<article class="card area">
  <div class="title">Atraso Top 8</div>
  <div class="chartArea"><canvas id="chartArea"></canvas></div>
</article>

<!-- TICKER -->
<section class="card ticker">
  <div class="tickerHead">
    <div class="title">Pendências</div>
  </div>
  <div class="table" id="tickerTable"></div>
</section>

</section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_URL = "https://custodiabackend-prod.idsf.com.br/api/ZiSign/TV?cnpjCertificadora=54638076000176";

const elClock=document.getElementById("clock");
const elTotal=document.getElementById("totalCount");
const elRate=document.getElementById("rateNum");

const delayPinned=document.getElementById("delayPinned");
const delayListTop=document.getElementById("delayListTop");
const elTable=document.getElementById("tickerTable");

const pad=n=>n<10?"0"+n:n;
setInterval(()=>{
  const d=new Date();
  elClock.textContent=`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
},1000);

/* ===== SCROLL PENDÊNCIAS (TV SAFE) ===== */
let tickerRAF=null;
function startTickerScroll(){
  cancelAnimationFrame(tickerRAF);
  let dir=1,last=0;

  function step(t){
    if(!last) last=t;
    const dt=(t-last)/1000; last=t;

    const max = elTable.scrollHeight - elTable.clientHeight;
    if(max > 4){
      elTable.scrollTop += dir * 14 * dt;
      if(elTable.scrollTop >= max){ dir=-1; }
      if(elTable.scrollTop <= 0){ dir=1; }
    }
    tickerRAF=requestAnimationFrame(step);
  }
  tickerRAF=requestAnimationFrame(step);
}

/* ===== SCROLL ATRASOS (TOP 2 FIXO) ===== */
let delayY=0, delayRAF=0, delayShift=0;

function renderDelayTop(atrasadas){
  cancelAnimationFrame(delayRAF);
  delayPinned.innerHTML="";
  delayListTop.innerHTML="";
  delayY=0;

  if(!atrasadas.length){
    delayPinned.innerHTML="<div>Sem atrasos</div>";
    return;
  }

  const map=new Map();
  atrasadas.forEach(ev=>{
    const k=ev.idOperacaoRecebivel;
    if(!map.has(k) || ev.atrasoSeg>map.get(k).atrasoSeg) map.set(k,ev);
  });

  const items=[...map.values()].sort((a,b)=>b.atrasoSeg-a.atrasoSeg);

  const max=items[0]?.atrasoSeg||1;

  function renderItem(ev){
    const pct=(ev.atrasoSeg/max)*100;
    const div=document.createElement("div");
    div.className="delay-item";
    div.innerHTML=`
      <div><strong>Operação ${ev.idOperacaoRecebivel}</strong></div>
      <div class="delay-time">${ev.nomeFundo}</div>
      <div class="delay-time">${ev.atrasoStr}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
    `;
    return div;
  }

  // TOP 2 fixos
  if(items[0]) delayPinned.appendChild(renderItem(items[0]));
  if(items[1]) delayPinned.appendChild(renderItem(items[1]));

  const rest = items.slice(2);
  rest.forEach(ev=>delayListTop.appendChild(renderItem(ev)));

  requestAnimationFrame(()=>{
    delayShift = delayListTop.scrollHeight;
    rest.forEach(ev=>delayListTop.appendChild(renderItem(ev))); // clone loop

    function loop(){
      delayY += 0.6; // DEVAGAR (TV)
      if(delayY >= delayShift) delayY=0;
      delayListTop.style.transform = `translateY(${-delayY}px)`;
      delayRAF=requestAnimationFrame(loop);
    }
    loop();
  });
}

/* ===== TABLE ===== */
function renderTabela(eventos){
  elTable.innerHTML="";
  eventos.slice(0,80).forEach(ev=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="time">${ev.horario||"--:--:--"}</div>
      <div>${ev.nomeFundo||""}<br><small>${ev.idOperacaoRecebivel}</small></div>
      <div class="tag bad">PENDENTE</div>
      <div>${ev.atrasoStr}</div>
    `;
    elTable.appendChild(row);
  });
  startTickerScroll();
}

/* ===== FETCH ===== */
async function carregar(){
  const r = await fetch(API_URL);
  const json = await r.json();
  const eventos = Array.isArray(json) ? json : json.data || [];

  const atrasadas=[];
  let ultHora=0;
  const now=new Date();

  eventos.forEach(ev=>{
    const [h,m,s]=(ev.hrAtraso||"00:00:00").split(":").map(Number);
    ev.atrasoSeg=h*3600+m*60+s;
    ev.atrasoStr=`${pad(h)}:${pad(m)}:${pad(s)}`;
    if(ev.atrasoSeg>0) atrasadas.push(ev);

    const [hh,mm,ss]=(ev.horario||"00:00:00").split(":").map(Number);
    const ts=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,ss).getTime();
    if(now-ts < 3600000) ultHora++;
  });

  elTotal.textContent = eventos.length;
  elRate.textContent = ultHora;

  renderDelayTop(atrasadas);
  renderTabela(eventos);
}

carregar();
setInterval(carregar,20000);
</script>
</body>
</html>
