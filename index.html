<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ZiSign</title>
<link rel="icon" type="image/png" href="img/ZiSignPNG.png"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet"/>

<style>
  :root{
    --bg0:#05070b; --bg1:#070c12;
    --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.04);
    --border:rgba(255,255,255,.10);
    --muted:rgba(255,255,255,.65);
    --text:rgba(255,255,255,.92);
    --accent:#00f0c0; --danger:#ff5c7a;
    --shadow:0 22px 70px rgba(0,0,0,.55);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  html{font-size:clamp(12px, .85vw, 16px)}
  body{
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:
      radial-gradient(900px 600px at 10% 20%, rgba(0,240,192,.10) 0%, transparent 60%),
      radial-gradient(900px 600px at 90% 10%, rgba(0,160,255,.10) 0%, transparent 60%),
      linear-gradient(180deg,var(--bg0),var(--bg1));
    color:var(--text);
    overflow:auto;
  }

  .wrap{
    min-height:100vh;
    width:min(100vw, 2560px);
    margin:0 auto;
    padding:clamp(10px, 1.2vw, 18px);
    display:grid;
    grid-template-rows:auto 1fr auto;
    gap:clamp(10px, 1vw, 14px);
  }

  header{display:flex; align-items:center; justify-content:space-between; padding:10px 12px;}
  .brand{display:flex;align-items:center;gap:12px;opacity:.95}
  .brand img{
    height:clamp(70px, 9vh, 130px);
    width:auto;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,.45));
  }
  .brand .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 6px rgba(0,240,192,.10);}
  .clock{
    font-weight:800; letter-spacing:.18em; font-size:.8rem;
    color:rgba(255,255,255,.88);
    padding:10px 14px;
    border-radius:999px;
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
  }

  .top-grid{
    display:grid;
    grid-template-columns:1fr 1fr 1.15fr;
    gap:clamp(10px, 1vw, 14px);
    min-height:0;
  }

  .card{
    min-height:0;
    border-radius:20px;
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    backdrop-filter: blur(14px);
    padding:clamp(12px, 1vw, 16px);
    display:flex; flex-direction:column; gap:12px;
  }
  .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .card-title{
    font-weight:800; font-size:.75rem; letter-spacing:.12em;
    text-transform:uppercase; color:rgba(255,255,255,.78);
  }

  .pill{
    font-size:.72rem; font-weight:900;
    padding:7px 11px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    color:rgba(255,255,255,.82);
    white-space:nowrap;
  }
  .pill.ok{border-color:rgba(0,240,192,.25); color:var(--accent); background:rgba(0,240,192,.08)}
  .pill.bad{border-color:rgba(255,92,122,.25); color:var(--danger); background:rgba(255,92,122,.08)}

  .kpi{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
  .kpi .num{font-size:clamp(34px, 3.2vw, 56px);line-height:1;font-weight:900;letter-spacing:-.02em}
  .kpi .sub{color:var(--muted);font-size:.8rem;margin-top:6px}
  .kpi .right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}

  /* ===== Maiores atrasos (sem buraco + top1/top2 fixos) ===== */
  .delay-list{
    position:relative;
    min-height:0;
    height:290px;            /* TV: mais área, sem “vazio” visual */
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .delay-pinned{display:flex;flex-direction:column;gap:8px}

  .delay-scroll{
    min-height:0;
    flex:1;
    overflow:hidden;
  }

  .delay-track{
    display:flex;
    flex-direction:column;
    gap:8px;
    will-change: transform;
  }

  .delay-item{
    padding:10px 12px; border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.14);
    display:flex;flex-direction:column;gap:6px;
  }
  .delay-item.p1{border-color:rgba(0,240,192,.22); background:rgba(0,240,192,.06)}
  .delay-item.p2{border-color:rgba(0,184,255,.18); background:rgba(0,184,255,.05)}

  .delay-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  .delay-op{font-weight:900;font-size:.9rem;line-height:1.1;opacity:.95}
  .delay-time{font-variant-numeric:tabular-nums;color:var(--muted);font-weight:900;white-space:nowrap}
  .delay-fundo{
    margin-top:6px;
    font-weight:700;
    font-size:.78rem;
    color:rgba(255,255,255,.72);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:46ch;
  }
  .delay-cnpj{color:rgba(255,255,255,.55);font-weight:800}
  .bar{height:7px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg, rgba(255,92,122,.95), rgba(255,170,170,.95));width:30%}

  .delay-scroll.auto .delay-track{
    animation: delayScroll var(--delayDur, 60s) linear infinite;
  }
  @keyframes delayScroll{
    0%   { transform: translateY(0); }
    100% { transform: translateY(calc(-1 * var(--delayShift, 0px))); }
  }
  @media (prefers-reduced-motion: reduce){
    .delay-scroll.auto .delay-track{ animation:none; }
  }

  .gauge{flex:1;display:grid;place-items:center;padding:6px 0}
  .ring{width:100%;max-width:240px;aspect-ratio:1/1;position:relative}
  .ring svg{width:100%;height:100%;transform:rotate(-90deg)}
  .ring .center{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
  .ring .center .big{font-size:clamp(30px, 2.5vw, 44px);font-weight:900}

  .chart-wrap{
    flex:1;min-height:220px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.12);
    padding:10px;
  }
  .chart-wrap canvas{width:100% !important;height:100% !important}

  .rank{display:flex;flex-direction:column;gap:8px}
  .rank-row{
    display:grid;
    grid-template-columns:22px 1fr auto;
    gap:10px; align-items:center;
    padding:9px 11px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.06);
    background:rgba(255,255,255,.03);
  }
  .pos{font-weight:900;color:var(--accent)}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .val{font-variant-numeric:tabular-nums;color:var(--muted);font-weight:900}

  .ticker{
    border-radius:20px;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    box-shadow:var(--shadow);
    backdrop-filter: blur(14px);
    display:flex;flex-direction:column;
    min-height:0;
  }
  .ticker-head{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 16px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .ticker-head .left{
    font-weight:900;letter-spacing:.12em;text-transform:uppercase;
    font-size:.75rem;color:rgba(255,255,255,.78);
  }

  .table{padding:12px 14px; overflow:auto; display:grid; gap:10px; min-height:0;}
  .row{
    display:grid;
    grid-template-columns:90px 1fr 120px 120px;
    gap:10px; align-items:center;
    padding:12px 12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.12);
  }
  .time{font-variant-numeric:tabular-nums;font-weight:900;color:rgba(255,255,255,.88)}
  .main{display:flex;flex-direction:column;gap:4px;min-width:0}
  .main b{font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .main span{font-size:.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tag{
    justify-self:start;
    font-size:.72rem;font-weight:900;
    padding:7px 11px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
  }
  .tag.ok{border-color:rgba(0,240,192,.25); color:var(--accent); background:rgba(0,240,192,.08)}
  .tag.bad{border-color:rgba(255,92,122,.25); color:var(--danger); background:rgba(255,92,122,.08)}
  .late{justify-self:end;font-variant-numeric:tabular-nums;font-weight:900;color:rgba(255,255,255,.90)}

  footer{display:flex;align-items:center;justify-content:space-between; padding:10px 12px; color:rgba(255,255,255,.55); font-size:.72rem;}

  @media (max-width:1400px){
    .top-grid{grid-template-columns:1fr}
    .row{grid-template-columns:90px 1fr}
    .row > :nth-child(3), .row > :nth-child(4){justify-self:start}
    footer{flex-direction:column;align-items:flex-start;gap:6px}
    .delay-top{flex-direction:column;align-items:flex-start}
    .delay-time{margin-top:6px}
    .delay-fundo{white-space:normal;max-width:100%}
  }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="img/ZiSignPNG.png" alt="ZiSign"/>
      <span class="dot" aria-hidden="true"></span>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </header>

  <section class="top-grid">
    <article class="card">
      <div class="card-head">
        <div class="card-title">Visão geral</div>
        <span class="pill" id="panelStatus">Atualizado</span>
      </div>

      <div class="kpi">
        <div>
          <div class="num" id="totalCount">0</div>
          <div class="sub" id="subCount">—</div>
        </div>
        <div class="right">
          <span class="pill ok" id="rateTextMain">—</span>
        </div>
      </div>

      <div>
        <div class="card-title" style="margin-bottom:8px;opacity:.9">Maiores atrasos</div>

        <div class="delay-list">
          <div class="delay-pinned" id="delayPinned"></div>
          <div class="delay-scroll" id="delayScrollWrap">
            <div class="delay-track" id="delayListTop"></div>
          </div>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="card-head">
        <div class="card-title">Ritmo</div>
        <span class="pill" id="rateTextSecondary">—</span>
      </div>

      <div class="gauge">
        <div class="ring">
          <svg viewBox="0 0 120 120">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#00ffc2"/>
                <stop offset="100%" stop-color="#00b8ff"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="10" />
            <circle id="arc" cx="60" cy="60" r="50" fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" stroke-dasharray="0 999" />
          </svg>
          <div class="center">
            <div class="big" id="rateNum">0</div>
          </div>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="card-head">
        <div class="card-title">Fundos</div>
        <span class="pill">média (7 dias)</span>
      </div>

      <div style="font-weight:900;font-size:1rem" id="topFundHeadline">Nenhum atraso registrado</div>
      <div class="chart-wrap"><canvas id="chartTopFundos"></canvas></div>
      <div class="rank" id="topFundList"></div>
    </article>
  </section>

  <section class="ticker" aria-live="polite">
    <div class="ticker-head">
      <div class="left">Pendências</div>
      <div class="pill" id="footerRateText">—</div>
    </div>
    <div class="table" id="tickerTable"></div>
  </section>

  <footer>
    <div id="footerRateSecondary"></div>
    <div style="white-space:nowrap;">contato@zisign.ai — © 2025 ZiSign</div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const CFG = {
  cnpj:  "54638076000176",
  base:  "https://custodiabackend-prod.idsf.com.br",
  amb:   "custodia",
  token: "DHQzckJ0TGWHiFxaVuUlmrBLWXwuejrtSAT0Mf47gvclZ5GKY543iYKNeLfqlzngXH0YcKGLe4qyv0avru3xeVGBp9yUQKKKlSyJ"
};

(() => {
  const q = new URLSearchParams(location.search);
  for (const k of ["base","cnpj","amb","token"]) {
    const v = q.get(k);
    if (v) CFG[k] = v;
  }
})();

const API_URL = `${CFG.base}/api/ZiSign/TV?cnpjCertificadora=${encodeURIComponent(CFG.cnpj)}`;

const elClock   = document.getElementById("clock");
const elTotal   = document.getElementById("totalCount");
const elSub     = document.getElementById("subCount");
const elTable   = document.getElementById("tickerTable");
const elRateTextMain = document.getElementById("rateTextMain");
const elRateTextSecondary = document.getElementById("rateTextSecondary");
const elRateNum = document.getElementById("rateNum");
const elPanelStatus = document.getElementById("panelStatus");
const arc       = document.getElementById("arc");

const elDelayPinned = document.getElementById("delayPinned");
const elDelayListTop = document.getElementById("delayListTop");
const elDelayScrollWrap = document.getElementById("delayScrollWrap");

const elTopFundHeadline = document.getElementById("topFundHeadline");
const elTopFundList = document.getElementById("topFundList");
const elFooterRateText = document.getElementById("footerRateText");
const elFooterRateSecondary = document.getElementById("footerRateSecondary");

const STORAGE_KEY = "zisign_tv_hist_7d";
const MILLIS_7D = 7 * 24 * 60 * 60 * 1000;

const pad2 = n => (n<10 ? "0"+n : ""+n);
const formatCnpj = cnpj => {
  const d = (cnpj || "").toString().replace(/\D/g,"");
  if (d.length !== 14) return cnpj || "";
  return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,"$1.$2.$3/$4-$5");
};
const abreviarFundo = (nome, max=24) => {
  if(!nome) return "";
  const n = nome.trim();
  if(n.length <= max) return n;
  return n.slice(0, max-1) + "…";
};
function animateCount(el, from, to, duration=350){
  const start = performance.now();
  function step(ts){
    const p = Math.min(1, (ts-start)/duration);
    const val = Math.round(from + (to-from)*p);
    el.textContent = val.toLocaleString("pt-BR");
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
setInterval(()=>{
  const d = new Date();
  elClock.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}, 1000);

function updateGauge(val){
  const max = 60;
  const pct = Math.max(0, Math.min(1, val/max));
  const C = 2 * Math.PI * 50;
  const dash = (C * pct).toFixed(1);
  arc.setAttribute("stroke-dasharray", `${dash} ${Math.max(0,C-dash).toFixed(1)}`);
  elRateNum.textContent = val.toFixed(0);
  const txt = `${val} evento${val !== 1 ? "s" : ""} na última hora`;
  elRateTextMain.textContent = txt;
  elRateTextSecondary.textContent = txt;
}

/* ===== HISTÓRICO / CHART (mantido) ===== */
function carregarHistorico(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return []; const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch{ return []; } }
function salvarHistorico(hist){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(hist)); }catch{} }
function limparHistoricoAntigo(hist){ const limite=Date.now()-MILLIS_7D; return hist.filter(e => (e.registradoEm||0) >= limite); }
let historicoEventos = carregarHistorico();
let chartTopFundos = null;

function formatDurationFromSeconds(totalSeconds){
  const s = Math.max(0, Math.floor(totalSeconds || 0));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
}

function atualizarGraficoFundos(ranking){
  if(!ranking || ranking.length === 0){
    elTopFundHeadline.textContent = "Nenhum atraso registrado nos últimos 7 dias";
    elTopFundList.innerHTML = "";
    if(chartTopFundos){ chartTopFundos.destroy(); chartTopFundos = null; }
    return;
  }

  const top = ranking[0];
  elTopFundHeadline.textContent =
    `${abreviarFundo(top.nomeFundo, 42)} — ${formatDurationFromSeconds(top.mediaAtrasoSeg)}`;

  elTopFundList.innerHTML = "";
  ranking.slice(0,5).forEach((f,i)=>{
    const row = document.createElement("div");
    row.className = "rank-row";
    row.innerHTML = `
      <div class="pos">${i+1}</div>
      <div class="name" title="${f.nomeFundo}">${abreviarFundo(f.nomeFundo, 34)}</div>
      <div class="val">${formatDurationFromSeconds(f.mediaAtrasoSeg)}</div>
    `;
    elTopFundList.appendChild(row);
  });

  const ctx = document.getElementById("chartTopFundos").getContext("2d");
  const top5 = ranking.slice(0,5);
  const labels = top5.map(f=>abreviarFundo(f.nomeFundo, 20));
  const data = top5.map(f=>Number((f.mediaAtrasoSeg/60).toFixed(1)));
  const top5Ref = top5.map(f => ({ ...f }));

  if(chartTopFundos) chartTopFundos.destroy();

  chartTopFundos = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ data, borderRadius:12 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      animation:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            title:(items)=> top5Ref[items[0].dataIndex]?.nomeFundo || items[0].label,
            label:(c)=> `${Number(c.raw).toLocaleString("pt-BR",{minimumFractionDigits:1,maximumFractionDigits:1})} min`
          }
        }
      },
      scales:{
        x:{ ticks:{color:"rgba(255,255,255,.65)",font:{size:11}}, grid:{display:false} },
        y:{ beginAtZero:true, ticks:{color:"rgba(255,255,255,.65)",font:{size:11}}, grid:{color:"rgba(255,255,255,.06)"} }
      }
    }
  });
}

function construirRanking7Dias(){
  historicoEventos = limparHistoricoAntigo(historicoEventos);

  const porFundo = new Map();
  for(const h of historicoEventos){
    if(!h?.nomeFundo) continue;
    const atrasoSeg = h.atrasoSeg || 0;
    if(atrasoSeg <= 0) continue;

    const key = (h.cnpjFundo || h.nomeFundo).toString();
    if(!porFundo.has(key)){
      porFundo.set(key,{ nomeFundo:h.nomeFundo, cnpjFundo:h.cnpjFundo||"", totalAtrasoSeg:0, qtd:0 });
    }
    const agg = porFundo.get(key);
    agg.totalAtrasoSeg += atrasoSeg;
    agg.qtd += 1;
  }

  const ranking = Array.from(porFundo.values())
    .filter(f=>f.qtd>0)
    .map(f=>({ nomeFundo:f.nomeFundo, cnpjFundo:f.cnpjFundo, mediaAtrasoSeg:f.totalAtrasoSeg/f.qtd }))
    .sort((a,b)=>b.mediaAtrasoSeg - a.mediaAtrasoSeg);

  atualizarGraficoFundos(ranking);
}

/* ===== MAIORES ATRASOS: sem espaço vazio (preenche) + loop perfeito + lento ===== */
function renderDelayTop(atrasadas){
  // reset
  elDelayPinned.innerHTML = "";
  elDelayListTop.innerHTML = "";
  elDelayScrollWrap.classList.remove("auto");
  elDelayScrollWrap.style.removeProperty("--delayShift");
  elDelayScrollWrap.style.removeProperty("--delayDur");

  if(!atrasadas.length){
    elDelayPinned.innerHTML = `<div style="color:rgba(255,255,255,.55);font-weight:900">Sem atrasos</div>`;
    return;
  }

  // dedup por operação (pega maior atraso por ID)
  const mapOps = new Map();
  for(const ev of atrasadas){
    const key = ev.idOperacaoRecebivel;
    if(!key) continue;
    const cur = mapOps.get(key);
    if(!cur || ev.atrasoSeg > cur.atrasoSeg) mapOps.set(key, ev);
  }

  const ordenadas = Array.from(mapOps.values()).sort((a,b)=>b.atrasoSeg-a.atrasoSeg);
  const items = ordenadas.slice(0, 30);
  const maxAtraso = items[0]?.atrasoSeg || 1;

  const renderItem = (ev, extraClass="") => {
    const pct = Math.max(10, (ev.atrasoSeg / maxAtraso) * 100);
    const row = document.createElement("div");
    row.className = `delay-item ${extraClass}`.trim();
    row.innerHTML = `
      <div class="delay-top">
        <div class="delay-op">
          Operação ${ev.idOperacaoRecebivel}
          <div class="delay-fundo" title="${ev.nomeFundo || ""}">
            ${abreviarFundo(ev.nomeFundo || "Fundo não identificado", 46)}
            <span class="delay-cnpj">· CNPJ ${formatCnpj(ev.cnpjFundo)}</span>
          </div>
        </div>
        <div class="delay-time">${ev.atrasoStr}</div>
      </div>
      <div class="bar"><i style="width:${pct.toFixed(1)}%"></i></div>
    `;
    return row;
  };

  // TOP 1 e 2 fixos
  if(items[0]) elDelayPinned.appendChild(renderItem(items[0], "p1"));
  if(items[1]) elDelayPinned.appendChild(renderItem(items[1], "p2"));

  // resto vai rolar
  const restBase = items.slice(2);
  if(restBase.length === 0) return;

  // 1) adiciona uma vez
  restBase.forEach(ev => elDelayListTop.appendChild(renderItem(ev)));

  // 2) PREENCHE: duplica até o conteúdo ficar MAIOR que a viewport (sem buraco)
  const viewH = elDelayScrollWrap.clientHeight;
  let guard = 0;
  while (elDelayListTop.scrollHeight < viewH * 1.15 && guard < 12) {
    restBase.forEach(ev => elDelayListTop.appendChild(renderItem(ev)));
    guard++;
  }

  // se ainda não ficou grande, deixa estático (mas preenchido)
  const baseHeight = elDelayListTop.scrollHeight;
  if(baseHeight <= viewH * 1.02) return;

  // 3) LOOP PERFEITO: duplica MAIS UMA “base” e anima o shift = altura ANTES de duplicar
  const shift = elDelayListTop.scrollHeight;
  restBase.forEach(ev => elDelayListTop.appendChild(renderItem(ev)));

  // 4) MAIS DEVAGAR: 8px/s (bem lento)
  const pxPerSecond = 8;
  const dur = Math.max(40, Math.min(160, shift / pxPerSecond));

  elDelayScrollWrap.classList.add("auto");
  elDelayScrollWrap.style.setProperty("--delayShift", `${shift}px`);
  elDelayScrollWrap.style.setProperty("--delayDur", `${dur.toFixed(1)}s`);
}

function renderTabela(eventos){
  elTable.innerHTML = "";
  if(!eventos.length){
    elTable.innerHTML = `
      <div class="row">
        <div class="time">—</div>
        <div class="main">
          <b>Nenhuma pendência</b>
          <span>Aguardando eventos</span>
        </div>
        <div class="tag ok">OK</div>
        <div class="late">00:00:00</div>
      </div>`;
    return;
  }

  eventos.slice()
    .sort((a,b)=>(b.atrasoSeg||0)-(a.atrasoSeg||0))
    .slice(0, 30)
    .forEach(ev=>{
      const isLate = (ev.atrasoSeg||0) > 0;
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="time">${ev.horario || "--:--:--"}</div>
        <div class="main">
          <b>${abreviarFundo(ev.nomeFundo||"", 44)}</b>
          <span>Operação ${ev.idOperacaoRecebivel} · CNPJ ${formatCnpj(ev.cnpjFundo)}</span>
        </div>
        <div class="tag ${isLate ? "bad" : "ok"}">${isLate ? "PENDENTE" : "OK"}</div>
        <div class="late">${ev.atrasoStr || "00:00:00"}</div>
      `;
      elTable.appendChild(row);
    });
}

async function carregarEventosReais(){
  try{
    elPanelStatus.className = "pill";
    elPanelStatus.textContent = "Carregando…";

    const res = await fetch(API_URL, {
      cache:"no-store",
      headers:{ "Ambiente": CFG.amb, "Token": CFG.token }
    });

    if(!res.ok){
      elPanelStatus.className = "pill bad";
      elPanelStatus.textContent = "Erro";
      console.error("Falha ao buscar dados", res.status, await res.text());
      renderTabela([]);
      return;
    }

    const json = await res.json();
    let eventos = [];
    if (Array.isArray(json)) eventos = json;
    else if (json && Array.isArray(json.data)) eventos = json.data;
    else if (json && json.data) eventos = [json.data];

    const atrasadas = [];
    const now = new Date();
    const nowMs = now.getTime();
    let eventosUltimaHora = 0;

    for(const ev of eventos){
      const atrasoRaw = (ev.hrAtraso || "00:00:00").toString().trim();
      const [ah,am,as] = atrasoRaw.split(":");
      const hh = Number(ah)||0, mm = Number(am)||0, ss = Number(as)||0;
      ev.atrasoSeg = hh*3600 + mm*60 + ss;
      ev.atrasoStr = `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
      if(ev.atrasoSeg>0) atrasadas.push(ev);

      const partes = (ev.horario || "00:00:00").split(":").map(Number);
      const ts = new Date(now.getFullYear(), now.getMonth(), now.getDate(), partes[0]||0, partes[1]||0, partes[2]||0).getTime();
      if(nowMs - ts <= 60*60*1000) eventosUltimaHora++;
    }

    const qtd = eventos.length;
    const atual = Number((elTotal.textContent || "0").replace(/\./g,"")) || 0;
    animateCount(elTotal, atual, qtd);
    elSub.textContent = qtd === 1 ? "1 assinatura" : `${qtd.toLocaleString("pt-BR")} assinaturas`;

    elFooterRateText.textContent = `${eventosUltimaHora} eventos / hora`;
    elFooterRateSecondary.textContent = "Atualização automática";
    elPanelStatus.className = "pill ok";
    elPanelStatus.textContent = "Online";

    updateGauge(eventosUltimaHora);
    renderDelayTop(atrasadas);
    renderTabela(eventos);

    historicoEventos = limparHistoricoAntigo(historicoEventos);
    for(const ev of atrasadas){
      const keyHist = `${ev.idOperacaoRecebivel || ""}-${ev.cnpjFundo || ""}`;
      const idx = historicoEventos.findIndex(h => h.key === keyHist);
      if(idx === -1){
        historicoEventos.push({
          key: keyHist,
          nomeFundo: ev.nomeFundo || "Fundo não identificado",
          cnpjFundo: ev.cnpjFundo || "",
          atrasoSeg: ev.atrasoSeg || 0,
          registradoEm: Date.now()
        });
      } else {
        historicoEventos[idx].atrasoSeg = ev.atrasoSeg || 0;
        historicoEventos[idx].registradoEm = Date.now();
      }
    }
    salvarHistorico(historicoEventos);
    construirRanking7Dias();

  } catch(e){
    elPanelStatus.className = "pill bad";
    elPanelStatus.textContent = "Erro";
    console.error("Erro ao carregar eventos", e);
    renderTabela([]);
  }
}

(function init(){
  construirRanking7Dias();
  carregarEventosReais();
  setInterval(carregarEventosReais, 20000);
})();
</script>
</body>
</html>
