<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ZiSign</title>
<link rel="icon" type="image/png" href="img/ZiSignPNG.png"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    --bg:#0b0d10; --grad-a:#04261c; --grad-b:#071b2a;
    --glass:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.1);
    --border:rgba(0,255,194,.28);
    --text:#eff9f7; --muted:#a8c7bd; --ink:#00100b;
    --green:#00d187; --green-200:#00ffc2; --accent:#19f5c8; --accent-2:#43ffd9;
    --warn:#ffb355; --ok:#1fe092;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 85% -10%, var(--grad-a) 0%, transparent 60%),
      radial-gradient(1000px 700px at 10% 110%, var(--grad-b) 0%, transparent 60%),
      linear-gradient(180deg,#0a0c0f 0%,#0b0d10 60%,#090b0e 100%);
    overflow:hidden; /* TV mode */
  }

  #fx{
    position:fixed; inset:0; z-index:0; pointer-events:none; filter:contrast(110%) saturate(110%);
  }

  .wrap{
    position:relative; z-index:1;
    height:100%; display:grid; gap:14px; padding:16px 18px;
    grid-template-rows:auto 1.05fr .85fr auto;
  }

  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background:linear-gradient(180deg,rgba(8,10,12,.65),rgba(8,10,12,.28));
    border:1px solid var(--border); border-radius:16px; padding:10px 14px;
    backdrop-filter:blur(10px);
    box-shadow:0 20px 80px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .brand{display:flex; align-items:center; gap:14px}
  .brand img{height:150px; width:auto; border-radius:12px; filter:drop-shadow(0 0 12px rgba(0,255,194,.25))}
  .brand h1{margin:0; color:var(--green-200); letter-spacing:.6px; font-size:clamp(1.1rem,2.2vw,1.5rem)}
  .clock{font-weight:900; color:var(--green-200); letter-spacing:1px; font-size:clamp(1rem,2vw,1.2rem)}

  .controls { display:none !important; }

  .btn, .switch, .speed{
    border:1px solid var(--border); border-radius:12px; font-weight:900;
    background:linear-gradient(180deg,rgba(0,255,194,.12),rgba(0,255,194,.05)); color:var(--text);
    padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 24px rgba(0,255,194,.08) inset, 0 8px 24px rgba(0,0,0,.2);
  }

  .band{
    display:grid; grid-template-columns:1.4fr .8fr; gap:14px; min-height:0;
  }

  .counter{
    position:relative; overflow:hidden;
    border:1px solid var(--border); border-radius:20px;
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    box-shadow:0 30px 100px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
    display:grid; grid-template-columns:1fr; place-items:center;
  }
  .counter::before{
    content:""; position:absolute; inset:-1px;
    background:radial-gradient(1200px 260px at -10% -40%, rgba(0,255,194,.18), transparent 60%),
               radial-gradient(1200px 260px at 110% 140%, rgba(0,209,135,.12), transparent 60%);
    pointer-events:none;
  }
  .counter .inner{
    display:grid; place-items:center; gap:16px; padding:4vh 2vw; text-align:center;
  }
  .label{opacity:.9;color:var(--muted);font-weight:800;font-size:clamp(1rem,2.2vw,1.3rem)}
  .big{
    font-size:clamp(68px,12.5vw,180px); line-height:1; font-weight:900; color:#fff;
    letter-spacing:1px;
    text-shadow:
      0 0 40px rgba(0,255,194,.35),
      0 0 12px rgba(0,255,194,.25),
      0 4px 22px rgba(0,0,0,.55);
    animation:glow 3.2s ease-in-out infinite;
  }
  @keyframes glow{
    0%,100%{text-shadow:0 0 30px rgba(0,255,194,.22),0 0 10px rgba(0,255,194,.18),0 4px 22px rgba(0,0,0,.55)}
    50%{text-shadow:0 0 52px rgba(67,255,217,.45),0 0 18px rgba(0,255,194,.30),0 10px 28px rgba(0,0,0,.65)}
  }
  .sub{opacity:.92;color:var(--muted);font-size:clamp(1rem,2vw,1.3rem);font-weight:800}

  .gauge{
    position:relative; overflow:hidden;
    border:1px solid var(--border); border-radius:20px;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    box-shadow:0 30px 100px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
    display:grid; place-items:center; padding:18px;
  }
  .g-head{font-weight:900; letter-spacing:.5px; color:var(--muted); margin-bottom:8px}
  .ring{
    width:min(64vh,42vw); max-width:560px; aspect-ratio:1/1; position:relative;
  }
  .ring svg{width:100%; height:100%; transform:rotate(-90deg)}
  .ring .value{
    position:absolute; inset:0; display:grid; place-items:center; text-align:center;
    font-weight:900; color:#fff;
  }
  .ring .value .num{font-size:clamp(28px,6vw,72px)}
  .ring .value .txt{color:var(--muted); margin-top:-4px}
  .ring .pulse{
    position:absolute; inset:0; border-radius:50%;
    box-shadow:0 0 60px rgba(0,255,194,.25), 0 0 120px rgba(0,255,194,.18);
    animation:pulse 3s ease infinite;
  }
  @keyframes pulse{
    0%,100%{opacity:.35} 50%{opacity:.8}
  }

  .mid{
    display:grid; grid-template-columns:1.6fr 1fr; gap:14px; min-height:0;
  }
  .ticker{
    position:relative; overflow:hidden;
    border:1px solid var(--border); border-radius:16px;
    background:linear-gradient(180deg,rgba(8,10,12,.65),rgba(8,10,12,.28));
    box-shadow:0 14px 60px rgba(0,0,0,.45);
  }
  .ticker::before{
    content:""; position:absolute; inset:0; backdrop-filter:blur(2px);
    background:linear-gradient(90deg, rgba(0,255,194,.05), transparent 30%, transparent 70%, rgba(0,255,194,.05));
    pointer-events:none;
  }
  .ticker-head{
    display:flex; align-items:center; justify-content:space-between; padding:10px 14px;
    color:var(--muted); font-weight:900; letter-spacing:.3px;
  }
  .ticker-row{
    white-space:nowrap; display:flex; gap:28px; align-items:center;
    padding:14px 0; border-top:1px solid var(--border);
    animation:scroll 40s linear infinite;
  }
  .ticker:hover .ticker-row{animation-play-state:paused}
  .tick{
    display:inline-flex; align-items:center; gap:12px; padding:12px 16px; margin-left:12px;
    border-radius:999px; background:rgba(0,255,194,.09); border:1px solid var(--border);
    font-weight:800; font-size:clamp(.9rem,1.9vw,1.05rem);
    box-shadow:0 8px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .pill{font-size:.8rem;font-weight:900;color:var(--ink);background:var(--green-200);padding:5px 12px;border-radius:999px;box-shadow:0 6px 16px rgba(0,255,194,.35)}

  @keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

  .highlights{
    display:grid; grid-template-columns:1fr; gap:12px; min-height:0;
  }
  .h-card{ perspective:1200px; position:relative; }
  .h-inner{
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border:1px solid var(--border); border-radius:16px; padding:14px 16px;
    color:var(--text); box-shadow:0 16px 60px rgba(0,0,0,.45);
    transform:rotateX(0deg) rotateY(0deg); transform-style:preserve-3d;
    transition:transform .25s ease, box-shadow .25s ease;
  }
  .h-card:hover .h-inner{
    transform:rotateX(4deg) rotateY(-4deg);
    box-shadow:0 24px 80px rgba(0,0,0,.55), 0 0 28px rgba(0,255,194,.18);
  }
  .h-title{font-size:.95rem; color:var(--muted); font-weight:900; margin-bottom:8px}
  .h-big{font-size:clamp(22px,3.2vw,34px); font-weight:900; color:#fff; text-shadow:0 0 18px rgba(0,255,194,.2)}
  .h-sub{opacity:.9; color:var(--muted); font-weight:800}

  footer{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    color:var(--muted); font-size:.95rem; opacity:.9;
  }
  .foot-right{font-weight:900; color:var(--green-200)}

  .toast{
    position:fixed; right:24px; bottom:24px; z-index:30;
    min-width:320px; max-width:420px; background:linear-gradient(180deg,#0f1214,#0c0f11);
    color:var(--text); border:1px solid var(--border); border-radius:18px;
    box-shadow:0 24px 90px rgba(0,0,0,.55), 0 0 30px rgba(0,255,194,.18);
    transform:translateY(20px); opacity:0; pointer-events:none; display:none;
  }
  .toast-inner{padding:16px 18px}
  .toast.show{display:block;animation:toastIn .35s ease forwards}
  .toast.hide{animation:toastOut .28s ease forwards}
  @keyframes toastIn{to{transform:translateY(0);opacity:1}}
  @keyframes toastOut{to{transform:translateY(10px);opacity:0}}

  @media (max-width: 1080px){
    .band{grid-template-columns:1fr}
    .mid{grid-template-columns:1fr}
  }

  #fx { display:none !important; }
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <header>
    <div class="brand">
      <img src="img/ZiSignPNG.png" alt="ZiSign"/>
    </div>
    <div class="clock" id="clock">--:--:--</div>
    <div class="controls">
      <button class="btn" id="btnFS">⛶ Tela cheia</button>
      <button class="btn" id="btnPlay">⏸ Pausar</button>
      <label class="switch" title="Som">
        <input id="toggleSound" type="checkbox" checked/>
        <span>Som</span>
      </label>
      <label class="switch" title="Toasts">
        <input id="toggleToast" type="checkbox" checked/>
        <span>Toasts</span>
      </label>
      <select id="speed" class="speed" title="Velocidade">
        <option value="24000">Lento</option>
        <option value="15000" selected>Médio</option>
        <option value="8500">Rápido</option>
      </select>
    </div>
  </header>

  <section class="band">
    <article class="counter">
      <div class="inner">
        <div class="label">Assinaturas exibidas</div>
        <div class="big" id="totalCount">0</div>
        <div class="sub" id="subCount">—</div>
      </div>
    </article>

    <article class="gauge">
      <div class="g-head">Ritmo atual (evts/última hora)</div>
      <div class="ring">
        <svg viewBox="0 0 120 120" preserveAspectRatio="xMidYMid meet">
          <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="10" />
          <circle id="arc" cx="60" cy="60" r="50" fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round"
                  stroke-dasharray="0 999" />
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#00ffc2"/>
              <stop offset="100%" stop-color="#00d187"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="value">
          <div class="num" id="rateNum">0</div>
          <div class="txt">evts/última hora</div>
        </div>
        <div class="pulse"></div>
      </div>
    </article>
  </section>

  <section class="mid">
    <article class="ticker" aria-live="polite">
      <div class="ticker-head">
        <div>Últimas assinaturas</div>
        <div style="opacity:.85" id="rateText">—</div>
      </div>
      <div class="ticker-row" id="tickerRow"></div>
    </article>

    <aside class="highlights">
      <div class="h-card">
        <div class="h-inner">
          <div class="h-title">Pico da última hora</div>
          <div class="h-big" id="peakHour">—</div>
          <div class="h-sub">Janela deslizante de 60 min</div>
        </div>
      </div>
      <div class="h-card">
        <div class="h-inner">
          <div class="h-title">Top documentos</div>
          <div class="h-big" id="topDocs">Operação</div>
        </div>
      </div>
      <div class="h-card">
        <div class="h-inner">
          <div class="h-title">Próximo pico estimado</div>
          <div class="h-big" id="nextPeak">11:00–12:00</div>
        </div>
      </div>
    </aside>
  </section>

  <footer>
    <div>contato@zisign.ai — © 2025 ZiSign</div>
  </footer>
</div>

<div class="toast" id="toast" role="status" aria-live="assertive" aria-atomic="true">
  <div class="toast-inner" id="toastContent"></div>
</div>

<audio id="ding" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
</audio>

<script>
/* partículas (mantido só pelo visual) */
(() => {
  const c = document.getElementById('fx');
  const ctx = c.getContext('2d');
  let w, h, dpr;
  function resize(){
    dpr = window.devicePixelRatio || 1;
    w = c.clientWidth; h = c.clientHeight;
    c.width = w*dpr; c.height = h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize); resize();

  const N = 110, pts = [];
  for(let i=0;i<N;i++){
    pts.push({
      x: Math.random()*w, y: Math.random()*h,
      r: Math.random()*2.2+0.6,
      a: Math.random()*Math.PI*2,
      sp: .2 + Math.random()*1.1,
      hue: 160 + Math.random()*60
    });
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for(const p of pts){
      p.a += (Math.random()-.5)*.12;
      p.x += Math.cos(p.a)*p.sp;
      p.y += Math.sin(p.a)*p.sp;

      if(p.x<-20) p.x=w+20; if(p.x>w+20) p.x=-20;
      if(p.y<-20) p.y=h+20; if(p.y>h+20) p.y=-20;

      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*6);
      g.addColorStop(0, `hsla(${p.hue},100%,60%,.28)`);
      g.addColorStop(1, `hsla(${p.hue},100%,60%,0)`);
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r*6,0,Math.PI*2); ctx.fill();

      ctx.fillStyle = `hsla(${p.hue},100%,70%,.85)`;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  tick();
})();

/* ==================== CONFIG API ==================== */
const CNPJ_CERTIFICADORA = "54638076000176"; // ajuste se precisar
const API_URL = `/dashboard/assinaturas?cnpjCertificadora=${CNPJ_CERTIFICADORA}`;

/* ==================== ESTADO & DOM ==================== */
let soundOn = true;
let toastOn = true;
let peakHourCnt = 0;

const elClock   = document.getElementById('clock');
const elTotal   = document.getElementById('totalCount');
const elSub     = document.getElementById('subCount');
const elTicker  = document.getElementById('tickerRow');
const elRateText= document.getElementById('rateText');
const elRateNum = document.getElementById('rateNum');
const elToast   = document.getElementById('toast');
const elToastContent = document.getElementById('toastContent');
const audioDing = document.getElementById('ding');
const arc       = document.getElementById('arc');
const elPeakHour= document.getElementById('peakHour');

/* utils */
const pad2 = n => (n<10?'0'+n:''+n);
function animateCount(el, from, to, duration=600){
  const start = performance.now();
  function step(ts){
    const p = Math.min(1, (ts-start)/duration);
    const val = Math.round(from + (to-from)*p);
    el.textContent = val.toLocaleString('pt-BR');
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* relógio */
setInterval(()=>{
  const d = new Date();
  elClock.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}, 1000);

/* toast */
let toastTimeout = null;
function showToast(html){
  if(!toastOn) return;
  elToastContent.innerHTML = html;
  elToast.classList.remove('hide');
  elToast.classList.add('show');
  elToast.style.pointerEvents='auto';
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(hideToast, 7500);
}
function hideToast(){
  elToast.classList.remove('show');
  elToast.classList.add('hide');
  elToast.style.pointerEvents='none';
  setTimeout(()=>{ elToast.classList.remove('hide'); elToast.style.display='none'; }, 280);
}
document.addEventListener('click', (e)=>{
  if(!elToast.contains(e.target)) hideToast();
});

/* gauge 0–60 */
function updateGauge(val){
  const max = 60;
  const pct = Math.max(0, Math.min(1, val/max));
  const C = 2 * Math.PI * 50;
  const dash = (C * pct).toFixed(1);
  arc.setAttribute('stroke-dasharray', `${dash} ${Math.max(0,C-dash).toFixed(1)}`);
  elRateNum.textContent = val.toFixed(0);
}

/* ==================== CARREGAR DADOS REAIS ==================== */
async function carregarEventosReais(){
  try{
    const res = await fetch(API_URL, { cache:"no-store" });
    if(!res.ok){
      console.error("Falha ao buscar dados", res.status);
      return;
    }
    const data = await res.json(); // array de {horario, idOperacaoRecebivel, nomeFundo, cnpjFundo, idFundo}
    const qtd = Array.isArray(data) ? data.length : 0;

    const atual = Number(elTotal.textContent.replace(/\./g,'')) || 0;
    animateCount(elTotal, atual, qtd);
    elSub.textContent = qtd === 1 ? "1 assinatura" : `${qtd.toLocaleString('pt-BR')} assinaturas`;

    elTicker.innerHTML = "";

    const now = new Date();
    const nowMs = now.getTime();
    let eventosUltimaHora = 0;

    data.forEach(ev=>{
      const div = document.createElement('div');
      div.className = "tick";
      div.innerHTML = `
        <span class="pill">${ev.horario}</span>
        <strong>${ev.nomeFundo}</strong>
        <span style="opacity:.85">• Op: ${ev.idOperacaoRecebivel} • CNPJ: ${ev.cnpjFundo}</span>
      `;
      elTicker.appendChild(div);

      const partes = (ev.horario || "00:00:00").split(":").map(Number);
      const hh = partes[0] || 0, mm = partes[1] || 0, ss = partes[2] || 0;
      const ts = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, ss).getTime();
      if(nowMs - ts <= 60*60*1000) eventosUltimaHora++;
    });

    updateGauge(eventosUltimaHora);
    elRateText.textContent = `${eventosUltimaHora} evts/última hora`;
    peakHourCnt = Math.max(peakHourCnt, eventosUltimaHora);
    elPeakHour.textContent = `${peakHourCnt.toLocaleString('pt-BR')} evts`;

    if(qtd > 0){
      const last = data[data.length - 1];
      showToast(`
        <div style="display:grid;gap:6px">
          <div><strong>${last.nomeFundo}</strong></div>
          <div>Operação ${last.idOperacaoRecebivel}</div>
          <div style="opacity:.9">CNPJ ${last.cnpjFundo}</div>
          <div style="opacity:.75">Atualizado às ${last.horario}</div>
        </div>
      `);
      if (document.hasFocus() && soundOn){
        try{ audioDing.currentTime = 0; audioDing.play().catch(()=>{});}catch{}
      }
    }

  } catch(e){
    console.error("Erro ao carregar eventos", e);
  }
}

/* simples: liga/desliga som/toast + fullscreen, se quiser usar depois */
document.getElementById('toggleSound')?.addEventListener('change', e=> soundOn = e.target.checked);
document.getElementById('toggleToast')?.addEventListener('change', e=>{ toastOn = e.target.checked; if(!toastOn) hideToast(); });
document.getElementById('btnFS')?.addEventListener('click', ()=>{
  if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); }
  else{ document.exitFullscreen?.(); }
});

/* boot */
(function init(){
  carregarEventosReais();
  setInterval(carregarEventosReais, 20000); // atualiza a cada 20s
})();
</script>
</body>
</html>
